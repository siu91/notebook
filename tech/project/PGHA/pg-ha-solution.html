<!DOCTYPE HTML>
<html lang="zh-CN" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>PG HA æ–¹æ¡ˆ - Siu çš„ç¬”è®°æœ¬</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../../../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
        <link rel="stylesheet" href="../../../theme/style.css">
        

        

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');
                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }
                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../../SUMMARY.html"><strong aria-hidden="true">1.</strong> æ€è€ƒå’Œæ€»ç»“ğŸ¤”</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../mgmt/srcwd/index.html"><strong aria-hidden="true">1.1.</strong> å›¢é˜Ÿäººå‘˜æ¨¡å‹</a></li><li class="chapter-item "><a href="../../../tech/backend/java-mem-mgmt/java-memory-management.html"><strong aria-hidden="true">1.2.</strong> è°ˆè°ˆ Java çš„å†…å­˜ç®¡ç†ï¼ˆdoingï¼‰</a></li></ol></li><li class="chapter-item expanded "><a href="../../../SUMMARY.html"><strong aria-hidden="true">2.</strong> æ¶æ„å’Œè®¾è®¡</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../tech/backend/Java-Backend-Framework-Selection-Guide.html"><strong aria-hidden="true">2.1.</strong> Java åç«¯æ¡†æ¶é€‰å‹æŒ‡å—ï¼ˆdoingï¼‰</a></li><li class="chapter-item expanded "><a href="../../../tech/project/PGHA/pg-ha-solution.html" class="active"><strong aria-hidden="true">2.2.</strong> PG HA æ–¹æ¡ˆ</a></li><li class="chapter-item "><a href="../../../tech/project/kubesphere/åŸºäºLinuxå®‰è£…kubesphere3å¤šèŠ‚ç‚¹é›†ç¾¤(prod).html"><strong aria-hidden="true">2.3.</strong> KuberSphere ç”Ÿäº§éƒ¨ç½²æ–¹æ¡ˆ</a></li><li class="chapter-item "><a href="../../../tech/project/lwpoc/lwpoc/æ¶æ„/æ„å»ºå®æ—¶æ¹–ä»“.html"><strong aria-hidden="true">2.4.</strong> æ„å»ºå®æ—¶æ¹–ä»“</a></li><li class="chapter-item "><a href="../../../tech/project/cicd/index.html"><strong aria-hidden="true">2.5.</strong> CICD è®¾è®¡</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../tech/project/cicd/design/CICDæ¶æ„.html"><strong aria-hidden="true">2.5.1.</strong> CI/CD æ¶æ„</a></li><li class="chapter-item "><a href="../../../tech/project/cicd/design/Jenkins_Cluster.html"><strong aria-hidden="true">2.5.2.</strong> Jenkins é›†ç¾¤</a></li><li class="chapter-item "><a href="../../../tech/project/cicd/design/å¤šåˆ†æ”¯æµæ°´çº¿è®¾è®¡.html"><strong aria-hidden="true">2.5.3.</strong> å¤šåˆ†æ”¯æµæ°´çº¿è®¾è®¡</a></li><li class="chapter-item "><a href="../../../tech/project/cicd/design/cec-jplè®¾è®¡.html"><strong aria-hidden="true">2.5.4.</strong> cec-jpl è®¾è®¡</a></li><li class="chapter-item "><a href="../../../tech/project/cicd/design/æ•°æ®åº“è‡ªåŠ¨åŒ–.html"><strong aria-hidden="true">2.5.5.</strong> æ•°æ®åº“è‡ªåŠ¨åŒ–</a></li><li class="chapter-item "><a href="../../../tech/project/cicd/design/è´¦å·ä½“ç³».html"><strong aria-hidden="true">2.5.6.</strong> è´¦å·ä½“ç³»</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../../SUMMARY.html"><strong aria-hidden="true">3.</strong> æœ€ä½³å®è·µ</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../tech/bestpractices/How-to-write-an-outline-for-a-technical-solution/index.html"><strong aria-hidden="true">3.1.</strong> æ€æ ·å†™ä¸€ä¸ªæŠ€æœ¯æ–¹æ¡ˆçš„å¤§çº²</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../tech/bestpractices/How-to-write-an-outline-for-a-technical-solution/template.html"><strong aria-hidden="true">3.1.1.</strong> ã€ŠæŠ€æœ¯è§£å†³æ–¹æ¡ˆã€‹æ¨¡ç‰ˆ</a></li></ol></li><li class="chapter-item "><a href="../../../tech/bestpractices/my-toolchain.html"><strong aria-hidden="true">3.2.</strong> åˆ†äº«ä¸€ä¸‹æˆ‘çš„å·¥å…·æ¸…å•</a></li><li class="chapter-item "><a href="../../../tech/bestpractices/sqlæ€§èƒ½æµ‹è¯•å·¥å…·çš„è®¾è®¡.html"><strong aria-hidden="true">3.3.</strong> sql æ€§èƒ½æµ‹è¯•å·¥å…·çš„è®¾è®¡</a></li><li class="chapter-item "><a href="../../../tech/bestpractices/jrudf/doris-remote-udf.html"><strong aria-hidden="true">3.4.</strong> Doris Remote UDF çš„å¼€å‘å’Œæµ‹è¯•</a></li><li class="chapter-item "><a href="../../../tech/bestpractices/ç¦…é“å·¥ä½œæµ.html"><strong aria-hidden="true">3.5.</strong> ç¦…é“å·¥ä½œæµ</a></li><li class="chapter-item "><a href="../../../tech/bestpractices/å•å…ƒæµ‹è¯•è§„èŒƒ.html"><strong aria-hidden="true">3.6.</strong> å•å…ƒæµ‹è¯•è§„èŒƒ</a></li><li class="chapter-item "><a href="../../../tech/bestpractices/æ•°æ®åº“è‡ªåŠ¨åŒ–-Flywayä½¿ç”¨è§„èŒƒ.html"><strong aria-hidden="true">3.7.</strong> æ•°æ®åº“è‡ªåŠ¨åŒ–ï¼šFlyway</a></li><li class="chapter-item "><a href="../../../tech/bestpractices/è¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶è§„èŒƒ.html"><strong aria-hidden="true">3.8.</strong> è¯­ä¹‰åŒ–ç‰ˆæœ¬</a></li><li class="chapter-item "><a href="../../../tech/bestpractices/APIè®¾è®¡è§„èŒƒ.html"><strong aria-hidden="true">3.9.</strong> APIè®¾è®¡è§„èŒƒ</a></li><li class="chapter-item "><a href="../../../tech/bestpractices/git-collaborative-development-tutorials/gitååŒå¼€å‘æŒ‡å—.html"><strong aria-hidden="true">3.10.</strong> git ååŒå¼€å‘æŒ‡å—</a></li><li class="chapter-item "><a href="../../../tech/bestpractices/code-review-guide-baseon-gitlab.html"><strong aria-hidden="true">3.11.</strong> Gitlab Code Review æŒ‡å—</a></li><li class="chapter-item "><a href="../../../tech/bestpractices/gitlab-issue-workflow.html"><strong aria-hidden="true">3.12.</strong> Gitlab Issue å·¥ä½œæµ</a></li><li class="chapter-item "><a href="../../../tech/bestpractices/Pythonç¼–ç è§„èŒƒ.html"><strong aria-hidden="true">3.13.</strong> Python ç¼–ç è§„èŒƒ</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Siu çš„ç¬”è®°æœ¬</h1>

                    <div class="right-buttons">
                        
                        
                        <a href="https://github.com/siu91/notebook" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                        

                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <!-- Page table of contents -->
                    <div class="sidetoc"><nav class="pagetoc"></nav></div>
                    <main>
                        <h1><a class="header" href="#pg-ha-æ–¹æ¡ˆ" id="pg-ha-æ–¹æ¡ˆ">PG HA æ–¹æ¡ˆ</a></h1>
<blockquote>
<p>By <a href="https://siu91.github.io/notes/#/./%E6%95%B0%E6%8D%AE%E5%BA%93/PG/PGHA/PG%20HA%E6%96%B9%E6%A1%88">Siu</a> 2020å¹´12æœˆ</p>
</blockquote>
<h1><a class="header" href="#1-ä»‹ç»" id="1-ä»‹ç»">1 ä»‹ç»</a></h1>
<blockquote>
<p>â€‹       æ–¹æ¡ˆä¸­ä½¿ç”¨ <a href="https://www.postgresql.org/docs/10/warm-standby-failover.html">PostgreSQL Failoverã€Warm Standby</a> çš„ç‰¹æ€§ï¼Œå®‰è£… <a href="https://github.com/citusdata/pg_auto_failover">pg_auto_failover</a> æ‰©å±•æœåŠ¡ï¼Œä¸ºPostgreSQL æœåŠ¡å®ç°å®‰å…¨çš„è‡ªåŠ¨æ•…éšœè½¬ç§»ã€‚</p>
</blockquote>
<p><em><strong>ä»¥ä¸‹æ–¹æ¡ˆæˆ–éªŒè¯ä¸­ï¼Œè€ƒè™‘å®é™…å•ä¸ªæœºæˆ¿å†…æŸå°ä¸»æœºçš„æ•…éšœæƒ…å†µï¼›éåº”å¯¹æ•´ä¸ªæœºæˆ¿ç˜«ç—ªçš„åŒæ´»/å¼‚åœ°å®¹ç¾é«˜å¯ç”¨æ–¹æ¡ˆã€‚</strong></em></p>
<p><strong>é«˜å¯ç”¨çš„å‡ ä¸ªé˜¶æ®µï¼š</strong></p>
<ul>
<li>
<p>å†·å¤‡ï¼šéœ€è¦åœæœºæ¢å¤ï¼Œæ•°æ®ä¸¢å¤±é£é™©ï¼›</p>
</li>
<li>
<p>åŒæœºçƒ­å¤‡ï¼šéœ€è¦åœæœºæ¢å¤ï¼›</p>
</li>
<li>
<h5><a class="header" href="#activestandby-æ¨¡å¼è¿›ä¸€æ­¥å¯ä»¥é…ç½®å•å†™å¤šè¯»è¯»å†™åˆ†ç¦»" id="activestandby-æ¨¡å¼è¿›ä¸€æ­¥å¯ä»¥é…ç½®å•å†™å¤šè¯»è¯»å†™åˆ†ç¦»">Active/Standby æ¨¡å¼ï¼šè¿›ä¸€æ­¥å¯ä»¥é…ç½®å•å†™å¤šè¯»ï¼Œè¯»å†™åˆ†ç¦»ï¼›</a></h5>
</li>
<li>
<p><del>äº’ä¸ºä¸»å¤‡</del>ï¼šç›¸æ¯”äº Active/Standby ï¼Œæ›´åˆç†ç†ç”±æœåŠ¡å™¨èµ„æºã€‚ç›®å‰ PG æ²¡æœ‰åˆé€‚çš„å€™é€‰æ–¹æ¡ˆï¼›</p>
</li>
<li>
<p>åŒåŸåŒæ´»ï¼šå¯ä»¥è§£å†³æŸä¸ª IDC æœºæˆ¿æ•´ä½“æŒ‚æ‰çš„æƒ…å†µï¼ˆåœç”µï¼Œæ–­ç½‘ç­‰ï¼‰ï¼›</p>
</li>
<li>
<p>å¼‚åœ°åŒæ´»ï¼šåº”å¯¹å¤§éƒ¨åˆ†çš„ç¾å¤‡æƒ…å†µï¼Œä½†æ˜¯ç¢°åˆ°å¤§é¢ç§¯åœç”µï¼Œæˆ–è€…è‡ªç„¶ç¾å®³çš„æ—¶å€™ï¼ŒæœåŠ¡ä¾ç„¶ä¼šä¸­æ–­ï¼›</p>
</li>
<li>
<p>å¼‚åœ°å¤šæ´»ï¼šç†æƒ³æ–¹æ¡ˆã€‚</p>
</li>
</ul>
<h2><a class="header" href="#11-æ¶æ„" id="11-æ¶æ„">1.1 æ¶æ„</a></h2>
<h3><a class="header" href="#111-two-standby-sync-æ¶æ„" id="111-two-standby-sync-æ¶æ„">1.1.1 two-standby-sync æ¶æ„</a></h3>
<blockquote>
<p>â€‹		<a href="https://pg-auto-failover.readthedocs.io/en/latest/architecture-multi-standby.html?#number-sync-standbys">two-standby-sync æ¶æ„</a>ï¼Œè¿™ç§æ¶æ„ä¸‹ä¸¤ä¸ª standby èŠ‚ç‚¹éƒ½å‚ä¸å¤åˆ¶ä»²è£ ï¼ˆNode Bã€Node Cï¼‰ï¼Œ<a href="https://pg-auto-failover.readthedocs.io/en/latest/architecture.html#synchronous-vs-asynchronous-replication">number_sync_standby = 1</a> ï¼Œç³»ç»Ÿå§‹ç»ˆç»´æŠ¤è‡³å°‘<strong>ä¸¤ä¸ªæ•°æ®é›†å‰¯æœ¬</strong>ï¼Œä¸€ä¸ªåœ¨ Node A ä¸»æ•°æ®åº“ä¸Šï¼Œå¦ä¸€ä¸ªåœ¨ Node B æˆ– Node C ä¸Šã€‚ä¸¢å¤±<strong>ä»»æ„ä¸€ä¸ª</strong>èŠ‚ç‚¹ï¼Œä»å¯ä¿è¯æ‹¥æœ‰ä¸¤ä¸ªæ•°æ®é›†å‰¯æœ¬ï¼Œä¸‰ä¸ªèŠ‚ç‚¹å®ç° Postgres <strong>æœåŠ¡å’Œæ•°æ®é›†</strong>çš„<strong>é«˜å¯ç”¨æ€§</strong>ã€‚</p>
<p>â€‹		å¦‚æœéœ€è¦å¢åŠ å¯ç”¨çš„æ•°æ®å‰¯æœ¬æ•°ï¼ŒæŒ‰åŒæ ·çš„é…ç½®å¢åŠ èŠ‚ç‚¹ ï¼Œå³å¯å˜æˆ <strong>N-standby-sync æ¶æ„</strong>ã€‚</p>
</blockquote>
<p><img src="assets/arch-two-standby-sync.svg" alt="" /></p>
<p><em><strong>æ³¨ï¼š</strong></em></p>
<blockquote>
<ul>
<li>Streaming Replication : <strong>æµå¤åˆ¶</strong>ï¼ŒPGçš„ç‰¹æ€§ä¹‹ä¸€ã€‚</li>
<li><a href="https://pg-auto-failover.readthedocs.io/en/latest/architecture.html#synchronous-vs-asynchronous-replication">number_sync_standby</a> ï¼šåŒæ­¥å¤åˆ¶çš„ standby èŠ‚ç‚¹æ•°ï¼›å†™æ“ä½œéƒ½ä¼šé˜»å¡ï¼Œç›´åˆ°è‡³å°‘æ”¶åˆ°<code>number_sync_standby</code> ä¸ªstandby èŠ‚ç‚¹æŠ¥å‘ŠåŒæ­¥å®Œæˆã€‚</li>
<li><a href="https://pg-auto-failover.readthedocs.io/en/latest/architecture-multi-standby.html?#replication-quorum">replication quorum</a>ï¼šæ˜¯å¦å‚ä¸å¤åˆ¶ä»²è£ï¼›ä¾‹å›¾ä¸­ 3 ä¸ª replication quorum = true ï¼ŒPrimary èŠ‚ç‚¹çš„å†™æ“ä½œåªè¦ä»»æ„ä¸€ä¸ª Secondary èŠ‚ç‚¹ç¡®è®¤å³å¯ã€‚</li>
<li>candidate priority ï¼šé€‰ä¸¾ä¼˜å…ˆçº§ï¼›å½“æ•…éšœè½¬ç§»æ—¶ï¼Œå€™é€‰èŠ‚ç‚¹æˆä¸ºä¸»èŠ‚ç‚¹çš„ä¼˜å…ˆçº§ã€‚</li>
<li>[replication quorum = true çš„èŠ‚ç‚¹æ•°]  &gt; number_sync_standbysï¼›ä¸€èˆ¬é…ç½®ä¸º [replication quorum = true çš„ standby èŠ‚ç‚¹æ•°]  = number_sync_standbys + 1 ã€‚</li>
<li>å½“å¯ç”¨ standby èŠ‚ç‚¹æ•° &lt; number_sync_standbys æ—¶ PG æœåŠ¡å°†<strong>é™çº§ä¸ºåªè¯»</strong>ï¼›æ•…å¹¶ä¸æ˜¯è¶Šå¤šçš„æ•°æ®å‰¯æœ¬ä»£è¡¨æ›´é«˜çš„å¯ç”¨æ€§ï¼Œæ•°æ®å¯ç”¨å‰¯æœ¬åªæ˜¯ä¿è¯äº†æ•°æ®çš„å®Œæ•´æ€§ï¼Œåœ¨å®é™…åœºæ™¯ä¸­è¦æƒè¡¡ã€‚</li>
<li>ä¸Šå›¾æ¶æ„ä¸­ Node Bã€C ä¸¤ä¸ª standby æ•…éšœæ—¶ï¼ŒPG å°†é™çº§ä¸ºåªè¯»ï¼›å°† number_sync_standbys è®¾ç½®ä¸º0ï¼Œå°†å…è®¸å†™å…¥æ•°æ®ï¼Œå³ä½¿ä¸¤ä¸ªå¤‡ç”¨èŠ‚ç‚¹éƒ½å¤„äºæ•…éšœçŠ¶æ€ä¹Ÿæ˜¯å¦‚æ­¤ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°†ä¿ç•™ç”Ÿäº§æ•°æ®é›†çš„å•ä¸ªå‰¯æœ¬ï¼Œå¦‚æœä¸»æ•°æ®åº“éšåå‘ç”Ÿæ•…éšœï¼Œåˆ™æŸäº›æ•°æ®å°†ä¸¢å¤±ï¼Œ å¤šå°‘å–å†³äºæ•°æ®å¤‡ä»½å’Œæ¢å¤æœºåˆ¶ã€‚</li>
</ul>
</blockquote>
<h3><a class="header" href="#112-three-standby-one-async-æ¶æ„" id="112-three-standby-one-async-æ¶æ„">1.1.2 three-standby-one-async æ¶æ„</a></h3>
<blockquote>
<p>â€‹		<a href="https://pg-auto-failover.readthedocs.io/en/latest/architecture-multi-standby.html?#sample-architectures-with-three-standby-nodes">three-standby-one-async æ¶æ„</a>ï¼Œä¸ two-standby-sync ä¸åŒçš„æ˜¯å¤šäº†ä¸€ä¸ª<strong>å¼‚æ­¥å¤åˆ¶</strong>çš„èŠ‚ç‚¹ <strong>Node D</strong> ã€‚</p>
<p>â€‹		è¿™ç§æ¶æ„é€‚åˆä»¥ä¸‹æƒ…å†µï¼š</p>
<p>â€‹		Node Aï¼ŒB ï¼Œ C éƒ¨ç½²åœ¨<strong>åŒä¸€æ•°æ®ä¸­å¿ƒ</strong>æˆ–å¯ç”¨æ€§åŒºåŸŸä¸­ï¼Œè€Œ Node D éƒ¨ç½²åœ¨å¦ä¸€ä¸ªæ•°æ®ä¸­å¿ƒæˆ–å¯ç”¨æ€§åŒºåŸŸä¸­ã€‚ </p>
</blockquote>
<p><img src="assets/arch-three-standby-one-async.svg" alt="" /></p>
<p><em><strong>æ³¨ï¼š</strong></em></p>
<blockquote>
<ul>
<li>Node D ä¸ä¼šä½œä¸ºæ•…éšœè½¬ç§»çš„å€™é€‰è€…ï¼ˆcandidate priority = 0 ï¼‰ã€‚</li>
</ul>
</blockquote>
<h2><a class="header" href="#12-å¯ç”¨æ€§åˆ†æ" id="12-å¯ç”¨æ€§åˆ†æ">1.2 å¯ç”¨æ€§åˆ†æ</a></h2>
<blockquote>
<p>ä¾æ® two-standby-sync æ¶æ„åšåˆ†æã€‚</p>
</blockquote>
<table><thead><tr><th></th><th>Monitor</th><th>PG Nodes</th><th>Available</th><th>Failover</th><th></th></tr></thead><tbody>
<tr><td>1</td><td>:heavy_check_mark: æ­£å¸¸</td><td>å¤§äº 2 ä¸ªèŠ‚ç‚¹å¯ç”¨</td><td><strong>æ˜¯</strong></td><td><strong>æ˜¯</strong></td><td>/</td></tr>
<tr><td>2</td><td>:heavy_check_mark:æ­£å¸¸</td><td>å°äºç­‰äº 1 ä¸ªèŠ‚ç‚¹å¯ç”¨</td><td><strong>å¦</strong></td><td><strong>å¦</strong></td><td>ä¸é…ç½®ç­–ç•¥ç›¸å…³ï¼Œå½“ number_sync_standbys &gt; 0 and synchronous_standby_names éç©ºæ—¶<strong>ä¸å¯å†™</strong></td></tr>
<tr><td>3</td><td>:x:æ•…éšœ</td><td>Primary å¯ç”¨ï¼Œè‡³å°‘1ä¸ª Secondary å¯ç”¨</td><td><strong>æ˜¯</strong></td><td><strong>å¦</strong></td><td>/</td></tr>
<tr><td>4</td><td>:x:æ•…éšœ</td><td>Primary ä¸å¯ç”¨ï¼ŒSecondary ä»»æ„çŠ¶æ€</td><td><strong>å¦</strong></td><td><strong>å¦</strong></td><td><strong>ä¸å¯å†™</strong></td></tr>
<tr><td>5</td><td><em><strong>any</strong></em></td><td>æ‰€æœ‰èŠ‚ç‚¹æ•…éšœ</td><td><strong>å¦</strong></td><td><strong>å¦</strong></td><td><strong>å®Œå…¨æ•…éšœ</strong></td></tr>
</tbody></table>
<p><em><strong>æ³¨ï¼š</strong></em></p>
<blockquote>
<p>â€‹		åªæœ‰ Primary èŠ‚ç‚¹æ—¶ï¼ˆæ‰€æœ‰ standby æ•…éšœï¼‰ï¼ŒæœåŠ¡å¯èƒ½é™çº§ä¸ºåªè¯»ï¼Œå–å†³äº number_sync_standbys å’Œ synchronous_standby_names çš„è®¾ç½®ã€‚</p>
</blockquote>
<h2><a class="header" href="#a-hrefhttpspg-auto-failoverreadthedocsioenlatestfaqhtmlthe-monitor-is-a-spof-in-pg-auto-failover-design-how-should-we-handle-that13-monitor-spof-a" id="a-hrefhttpspg-auto-failoverreadthedocsioenlatestfaqhtmlthe-monitor-is-a-spof-in-pg-auto-failover-design-how-should-we-handle-that13-monitor-spof-a"><a href="https://pg-auto-failover.readthedocs.io/en/latest/faq.html#the-monitor-is-a-spof-in-pg-auto-failover-design-how-should-we-handle-that">1.3 Monitor SPOF </a></a></h2>
<ul>
<li>Monitor æ•…éšœæ—¶ï¼Œå°†æ— æ³•æä¾›<strong>æ•…éšœè½¬ç§»</strong>æœåŠ¡ï¼›</li>
<li>Monitor æ•…éšœæ—¶ï¼Œå°†æ— æ³•åˆ†é…çŠ¶æ€ç»™PGèŠ‚ç‚¹ï¼ˆæ·»åŠ èŠ‚ç‚¹ã€æ•…éšœè½¬ç§»ã€èŠ‚ç‚¹ç»´æŠ¤ï¼‰ï¼›</li>
<li>Monitor æ•…éšœæ—¶ï¼Œå¯ä»¥<strong>æ— çŠ¶æ€</strong>ä¸‹<strong>å¿«é€Ÿæ¢å¤</strong>ï¼›</li>
<li>Monitor æ•…éšœæ—¶ï¼Œå¯ä»¥ä»å¤‡ä»½æ•°æ®ä¸­<strong>å¿«é€Ÿæ¢å¤</strong>ï¼›</li>
<li>Monitor æ•…éšœæ—¶ï¼Œ<strong>ä¸å½±å“PGæœåŠ¡</strong>ï¼›</li>
</ul>
<p><em><strong>æ³¨ï¼š</strong></em></p>
<blockquote>
<p><a href="https://baike.baidu.com/item/%E5%8D%95%E7%82%B9%E6%95%85%E9%9A%9C/3570893">SPOF</a>: å•ç‚¹æ•…éšœ (single point of failure)</p>
</blockquote>
<h3><a class="header" href="#131-monitor-spof-ä¼˜åŒ–" id="131-monitor-spof-ä¼˜åŒ–">1.3.1 Monitor SPOF ä¼˜åŒ–</a></h3>
<blockquote>
<p>â€‹		åœ¨ <a href="https://github.com/citusdata/pg_auto_failover">pg_auto_failover</a> åŸæœ‰åŠŸèƒ½åŸºç¡€ä¸Šï¼Œåˆ©ç”¨ keepalived çš„åŠŸèƒ½è®¾è®¡å®ç°ä¿è¯ Monitor èŠ‚ç‚¹çš„é«˜å¯ç”¨ã€‚åœ¨ Keepalived ä¸­é…ç½® <strong>VRRP instance</strong> ï¼Œå°†<code>VIP</code>ç»‘å®šåˆ°å¯ç”¨çš„èŠ‚ç‚¹ï¼Œä½¿ç”¨ <strong>track_script ã€notify_masterã€notify_backup</strong> å°† keepalived çš„çŠ¶æ€å’Œ pgafom çš„çŠ¶æ€ç»‘å®šï¼ŒåŒæ­¥<code>MASTER</code>å’Œ<code>BACKUP</code>æ•°æ®ï¼›ä½¿å¾—åŒä¸€æ—¶é—´å†…ï¼Œä¸¤å° MonitorèŠ‚ç‚¹åªè¦ä¿è¯ä¸€å°ä¸»æœºæ­£å¸¸ï¼Œå°±èƒ½ä¿è¯<strong>æœ‰ä¸”åªæœ‰ä¸€ä¸ª</strong> Monitor æœåŠ¡åœ¨çº¿å·¥ä½œã€‚</p>
</blockquote>
<img src="./assets/monitor-spof-solution.svg" style="zoom:175%" />
<p><strong>Monitor æ•…éšœè½¬ç§»ï¼š</strong></p>
<img src="./assets/arch-2standy-Monitor-Failover-Timing-diagram.svg" style="zoom:100%" />
<p><strong>æ³¨ï¼š</strong></p>
<blockquote>
<ul>
<li>åœ¨æ­¤é…ç½®ä¸­ pgafo æœåŠ¡ä¸éœ€è¦è®¾ç½® <code>systemed enable</code>ï¼›</li>
<li><a href="https://www.jianshu.com/p/7410507d57c3">VRRPå³è™šæ‹Ÿè·¯ç”±å†—ä½™åè®®(Virtual Router Redundancy Protocol)</a>ï¼Œå®ƒæ˜¯ä¸ºäº†<strong>é¿å…è·¯ç”±å™¨å‡ºç°å•ç‚¹æ•…éšœ</strong>çš„ä¸€ç§å®¹é”™åè®®ã€‚</li>
<li>MASTERã€BACKUP æ•°æ®åŒæ­¥ç›´æ¥é‡‡ç”¨æ•°æ®<strong>å¢é‡</strong>æ–‡ä»¶åŒæ­¥ï¼ˆrsyncï¼‰çš„æ–¹å¼ï¼Œä¸»è¦è€ƒè™‘ï¼š
<ul>
<li>1ã€æ•°æ®é‡éå¸¸å° </li>
<li>2ã€äº’ä¸º hot standy å®¹æ˜“æ•°æ®ä¸ä¸€è‡´ï¼Œä¸”ä¸¤ä¸ªèŠ‚ç‚¹ä»¥ä¸Šé…ç½®åˆ‡æ¢å¤æ‚ã€‚</li>
</ul>
</li>
</ul>
</blockquote>
<h3><a class="header" href="#132-ä¼˜åŒ–åçš„æ¶æ„" id="132-ä¼˜åŒ–åçš„æ¶æ„">1.3.2 ä¼˜åŒ–åçš„æ¶æ„</a></h3>
<img src="./assets/arch-2standy-pgafo-arch-optimization.svg" style="zoom:150%" />
<blockquote>
<p>â€‹		åœ¨æ­¤æ¶æ„ä¸‹ï¼Œè§£å†³äº†Monitor æœåŠ¡çš„å•ç‚¹æ•…éšœé—®é¢˜ï¼Œä¿è¯äº†åŒä¸€æ—¶é—´å†…æœ‰ä¸”åªæœ‰ä¸€ä¸ª Monitor æœåŠ¡åœ¨çº¿ã€‚ä¸Šå›¾ä¸­ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œä¼˜åŒ–æ–¹æ¡ˆå¯¹<strong>åº”ç”¨æ¥å…¥</strong>è¿™ä¸€å±‚æ²¡æœ‰ä»»ä½•å½±å“ã€‚</p>
</blockquote>
<h2><a class="header" href="#14-æ–¹æ¡ˆå›é€€" id="14-æ–¹æ¡ˆå›é€€">1.4 æ–¹æ¡ˆå›é€€</a></h2>
<blockquote>
<p>pg-auto-failover æœ¬èº«å¯¹PGæ•°æ®åº“æ²¡æœ‰ä¾µå…¥ï¼Œå›é€€æˆ–åˆ‡æ¢æ–¹æ¡ˆï¼Œåªè¦åšç›¸åº”çš„æ•°æ®è¿ç§»ã€‚</p>
</blockquote>
<h2><a class="header" href="#15-ä¸»æµæ–¹æ¡ˆå¯¹æ¯”" id="15-ä¸»æµæ–¹æ¡ˆå¯¹æ¯”">1.5 ä¸»æµæ–¹æ¡ˆå¯¹æ¯”</a></h2>
<blockquote>
<p>æ‰€æœ‰å¯¹æ¯”æ–¹æ¡ˆï¼Œå‡é‡‡ç”¨ <a href="https://www.postgresql.org/docs/10/warm-standby-failover.html">PostgreSQL Failoverã€Warm Standby</a> ä½œä¸ºHAæ ¸å¿ƒåŠŸèƒ½çš„è§£å†³æ–¹æ¡ˆã€‚</p>
</blockquote>
<table><thead><tr><th></th><th><a href="https://pgpool.net/mediawiki/index.php/Main_Page">Pgpool-II</a></th><th><a href="https://repmgr.org/">Repmgr</a></th><th><a href="https://patroni.readthedocs.io/en/latest/">Patroni</a></th><th><a href="https://github.com/citusdata/pg_auto_failover">pg_auto_failover</a></th></tr></thead><tbody>
<tr><td><strong>ç±»å‹</strong></td><td>middleware</td><td>afo tool</td><td>afo tool</td><td>afo tool</td></tr>
<tr><td><strong>å¼€æºåè®®</strong></td><td><a href="https://pgpool.net/mediawiki/index.php/pgpool-II_License">éå¼€æºã€å½“å‰å…è´¹</a></td><td><a href="https://repmgr.org/GPL-v3.txt">GPL v3</a></td><td><a href="https://github.com/zalando/patroni/blob/master/LICENSE">License (MIT)</a></td><td><a href="https://github.com/citusdata/pg_auto_failover/blob/master/LICENSE">PostgreSQL License</a></td></tr>
<tr><td><strong>æºç </strong></td><td>/</td><td><a href="https://github.com/2ndQuadrant/repmgr">2ndQuadrant/repmgr</a></td><td><a href="https://github.com/zalando/patroni">zalando/patroni</a></td><td><a href="https://github.com/citusdata/pg_auto_failover">citusdata/pg_auto_failover</a></td></tr>
<tr><td><strong>é…ç½®å¤æ‚åº¦</strong></td><td>è¾ƒé«˜</td><td>ä¸­</td><td>é«˜</td><td>ä½</td></tr>
<tr><td><strong>ç»´æŠ¤éš¾åº¦</strong></td><td>é«˜</td><td>ä½</td><td>ä¸­</td><td>ä½</td></tr>
<tr><td><strong>æ–‡æ¡£</strong></td><td><a href="https://www.pgpool.net/mediawiki/index.php/Documentation">è§„èŒƒã€è¯¦ç»† </a></td><td><a href="https://repmgr.org/docs/5.1/index.html">è§„èŒƒã€è¯¦ç»† </a></td><td><a href="https://patroni.readthedocs.io/en/latest/">è§„èŒƒã€è¯¦ç»† </a></td><td><a href="https://pg-auto-failover.readthedocs.io/">è§„èŒƒã€è¯¦ç»†ã€å‹å¥½ </a></td></tr>
<tr><td><strong>æ‰©å±•æ€§</strong></td><td>ä¸æ”¯æŒåŠ¨æ€å¢åŠ èŠ‚ç‚¹ï¼ˆå¾…ç¡®å®šï¼‰</td><td><em><strong>æœªæ”¶é›†ç›¸å…³ä¿¡æ¯</strong></em></td><td><em><strong>æœªæ”¶é›†ç›¸å…³ä¿¡æ¯</strong></em></td><td>æ”¯æŒåŠ¨æ€å¢åŠ èŠ‚ç‚¹ï¼Œåˆ é™¤èŠ‚ç‚¹</td></tr>
<tr><td><strong>åŠŸèƒ½</strong></td><td>è¿æ¥æ± ã€VIPã€è´Ÿè½½å‡è¡¡ã€è¯»å†™åˆ†ç¦»ã€æ•…éšœè½¬ç§»ã€æ•°æ®å¤åˆ¶</td><td>æ•…éšœè½¬ç§»ã€æ•°æ®å¤åˆ¶</td><td>æ•…éšœè½¬ç§»ã€æ•°æ®å¤åˆ¶</td><td>æ•…éšœè½¬ç§»ã€æ•°æ®å¤åˆ¶ã€èŠ‚ç‚¹æ‰©å±•</td></tr>
<tr><td><strong>é—®é¢˜</strong></td><td>Watchdog leader ã€æ•°æ®ä¸€è‡´æ€§å¯¼è‡´æ•…éšœè½¬ç§»å¤±è´¥</td><td>æœªçŸ¥ï¼ˆæœªéªŒè¯ï¼‰</td><td>æœªçŸ¥ï¼ˆæœªéªŒè¯ï¼‰</td><td>Monitor SPOF</td></tr>
<tr><td><strong>å›¢é˜Ÿ/å“ç‰Œ</strong></td><td>Pgpool-II</td><td>2ndQuadrant</td><td>Zalando SE</td><td>Microsoft/Citus Data</td></tr>
</tbody></table>
<blockquote>
<ul>
<li>ç±»å‹ï¼šè¿™éƒ¨åˆ†å„æœ‰æœ‰ç‚¹ï¼Œä¸­é—´ä»¶å¯¹ä¸šåŠ¡æ˜¯é€æ˜çš„ï¼Œæ— ä¾µå…¥ï¼Œå¦‚æœä¸­é—´ä»¶ç¨³å®šåŠŸèƒ½ä¸°å¯Œä¸”é€‚åˆä¸šåŠ¡éœ€æ±‚ï¼Œæ˜¯æ¯”è¾ƒå¥½çš„é€‰æ‹©ï¼›Patrotniå’Œå…¶å®ƒä¸¤ä¸ªçš„åŒºåˆ«åœ¨äºå®ƒæ˜¯ä¸€ä¸ªPythonçš„æ¨¡æ¿ï¼Œå¯ç”¨äºè‡ªä¸»é…ç½®PG HAå·¥å…·ï¼›</li>
<li>å¼€æºéƒ¨åˆ†ï¼šä¸»è¦è€ƒé‡ä¸»è¦åœ¨äºå¼€æºçƒ­åº¦ã€å›¢é˜Ÿå’Œå“ç‰Œã€è®¸å¯èŒƒå›´ï¼›</li>
<li>é…ç½®å’Œè¿ç»´ï¼šä¸»è¦è€ƒé‡ç›®å‰å›¢é˜Ÿå¯¹æ–°ç»„ä»¶åœ¨é¢„æœŸå†…çš„æŒæ¡ç¨‹åº¦å’Œæœªæ¥äº¤ç»´çš„èƒ½åŠ›ï¼›pg-pool ç»´æŠ¤éš¾åº¦è¾ƒé«˜ä¸€éƒ¨åˆ†æ˜¯é…ç½®è¾ƒä¸ºå¤æ‚ã€ä¸€éƒ¨åˆ†æ˜¯åŠŸèƒ½ä¸Šä¸°å¯Œï¼Œå¸¦æ¥ä¸€å®šçš„ç†Ÿæ‚‰éš¾åº¦ï¼›</li>
<li>æ‰©å±•æ€§ï¼šè¿™ä¸ªå’ŒåæœŸè¿ç»´å…³ç³»ç´§å¯†</li>
<li>åŠŸèƒ½ï¼šä¸»è¦è€ƒé‡æˆ‘ä»¬ç›®å‰çš„ä¸šåŠ¡éœ€æ±‚å’Œæœªæ¥çš„ä¸»è¦è§„åˆ’ï¼›</li>
<li>æ€§èƒ½ï¼šæ€§èƒ½éƒ¨åˆ†æœªå•ç‹¬è€ƒé‡ï¼Œå› ä¸ºåªæœ‰pg-poolæ–¹å¼éœ€è¦ç‰¹åˆ«è€ƒè™‘æ€§èƒ½ï¼ˆä¸­é—´ä»¶å’Œè¿æ¥æ± ï¼‰ï¼Œå…¶å®ƒåˆ—å‡ºçš„å‡ ç§æ–¹å¼éƒ½æ˜¯ç›´æ¥è¿æ¥PGï¼Œåªè·ŸPG é©±åŠ¨å’ŒåŒæ­¥å¤åˆ¶ç›¸å…³ï¼›åŸºå‡†æµ‹è¯•éƒ¨åˆ†ä¼šæœ‰ä¸ªåŸºç¡€ä¾æ®ï¼›</li>
</ul>
</blockquote>
<p><strong>æ³¨ï¼špg é©±åŠ¨æ”¯æŒè¯»å†™åˆ†ç¦»ï¼Œè´Ÿè½½å‡è¡¡ï¼ˆå¾…éªŒè¯ï¼‰</strong></p>
<h1><a class="header" href="#2-å‡†å¤‡" id="2-å‡†å¤‡">2 å‡†å¤‡</a></h1>
<h2><a class="header" href="#21-ä¸»æœºè§„åˆ’" id="21-ä¸»æœºè§„åˆ’">2.1 ä¸»æœºè§„åˆ’</a></h2>
<blockquote>
<p>å¼€å‘æµ‹è¯•ç¯å¢ƒ</p>
</blockquote>
<table><thead><tr><th>èŠ‚ç‚¹åç§°</th><th>CPU</th><th>å†…å­˜</th><th>ç³»ç»Ÿç›˜</th><th>æ•°æ®ç›˜1</th><th>æ•°æ®ç›˜2</th><th>å¤‡æ³¨</th><th>æ˜¯å¦å¿…é¡»</th></tr></thead><tbody>
<tr><td>pg-node1</td><td>4C</td><td>16G</td><td>60G</td><td>1T</td><td>60G</td><td>Postgres èŠ‚ç‚¹</td><td>æ˜¯</td></tr>
<tr><td>pg-node2</td><td>4C</td><td>16G</td><td>60G</td><td>1T</td><td>60G</td><td>Postgres èŠ‚ç‚¹</td><td>æ˜¯</td></tr>
<tr><td>pg-node3</td><td>4C</td><td>16G</td><td>60G</td><td>1T</td><td>60G</td><td>Postgres èŠ‚ç‚¹</td><td>æ˜¯</td></tr>
<tr><td>pg-afom1</td><td>2C</td><td>2G</td><td>60G</td><td>60G</td><td>/</td><td>pg afo  monitor èŠ‚ç‚¹</td><td>æ˜¯</td></tr>
<tr><td>pg-afom2</td><td>2C</td><td>2G</td><td>60G</td><td>60G</td><td>/</td><td>pg afo  monitor èŠ‚ç‚¹</td><td><strong>å¦</strong></td></tr>
</tbody></table>
<blockquote>
<p>è¯´æ˜ï¼š</p>
<ul>
<li>pg-node æ•°æ®ç›˜1ä½œä¸ºpostgres çš„æ•°æ®ç›˜ï¼Œç»Ÿä¸€æŒ‚è½½åœ¨ /data/pg10 ;æ•°æ®ç›˜2ä½œä¸ºpg-auto-failover monitoçš„æ•°æ®å¤‡ä»½ç›˜ç»Ÿä¸€æŒ‚è½½åœ¨ /pgafo/monitor</li>
<li>pg-afom æ•°æ®ç›˜1ä½œä¸ºpg-auto-failover monitoçš„æ•°æ®ç›˜å’Œæ•°æ®å¤‡ä»½ç›˜ç»Ÿä¸€æŒ‚è½½åœ¨ /pgafo/monitor</li>
<li>æ³¨ï¼šæµ‹è¯•ã€å¼€å‘ç¯å¢ƒèµ„æºä¸è¶³å¯ä»¥æš‚æ—¶è§„åˆ’ <code>4C/8G/20G/200G/20G</code> <code>2C/2G/20G/20G/</code></li>
<li>ç”Ÿäº§ç¯å¢ƒæ ¹æ®ä¸šåŠ¡è§„æ¨¡è§„åˆ’</li>
</ul>
<p>ç£ç›˜æŒ‚è½½ï¼šhttps://cloud.tencent.com/developer/article/1496311</p>
<ul>
<li>
<p>è®¾ç½®ä¸»æœºåï¼šhostnamectl set-hostname [host-name]</p>
<p>192.168.5.149 pg-node1
192.168.5.150 pg-node2
192.168.5.151 pg-node3
192.168.6.170 pg-afom1</p>
</li>
</ul>
</blockquote>
<h2><a class="header" href="#22-a-hrefhttpswwwpostgresqlorgdocs10kernel-resourceshtmlpostgres-kernel-è°ƒä¼˜a" id="22-a-hrefhttpswwwpostgresqlorgdocs10kernel-resourceshtmlpostgres-kernel-è°ƒä¼˜a">2.2 <a href="https://www.postgresql.org/docs/10/kernel-resources.html">Postgres Kernel è°ƒä¼˜</a></a></h2>
<blockquote>
<p>é’ˆå¯¹æ•°æ®åº“ç›¸å…³çš„å†…æ ¸å‚æ•°ï¼ŒæŒ‰éœ€è°ƒä¼˜ã€‚<a href="https://www.postgresql.org/docs/10/kernel-resources.html">å‚è€ƒ</a></p>
</blockquote>
<h2><a class="header" href="#23-é…ç½®èŠ‚ç‚¹æ—¶é’ŸåŒæ­¥" id="23-é…ç½®èŠ‚ç‚¹æ—¶é’ŸåŒæ­¥">2.3 é…ç½®èŠ‚ç‚¹æ—¶é’ŸåŒæ­¥</a></h2>
<blockquote>
<p><strong>ç”Ÿäº§å¿…é¡»</strong></p>
</blockquote>
<h2><a class="header" href="#24-é…ç½®sshäº’ä¿¡" id="24-é…ç½®sshäº’ä¿¡">2.4 é…ç½®SSHäº’ä¿¡</a></h2>
<blockquote>
<p>SSHæ–¹å¼è‡ªåŠ¨éƒ¨ç½²å¿…é¡»é…ç½®ï¼Œå‚è€ƒï¼š./pgafo -a</p>
</blockquote>
<h1><a class="header" href="#3-å®‰è£…" id="3-å®‰è£…">3 å®‰è£…</a></h1>
<pre><code class="language-shell"># è§£å‹éƒ¨ç½²åŒ…ï¼Œç›®å½•ä¸‹ configä¸ºé…ç½®æ–‡ä»¶
unzip PGHA.zip &amp;&amp; cd PGHA &amp;&amp; chmod +x pgafo
# -p åˆå§‹åŒ–å„èŠ‚ç‚¹
# -c æ¸…ç†æ—§çš„afoç¯å¢ƒï¼ˆé‡æ–°å®‰è£…æ—¶éœ€è¦ï¼‰
# -i å®‰è£…afoåŸºç¡€ç¯å¢ƒ
./pgafo -p -c -i

# -r å¯åŠ¨afo
su ha-admin
./pgafo -r
</code></pre>
<p>é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼ˆæŒ‰å®é™…é…ç½®ï¼‰ï¼š</p>
<pre><code class="language-shell"># ha-admin password,operation user
HA_ADMIN_PASS='ha1234'
# PG server trusted network segment
PG_HBA_MD5=&quot;192.168.31.1/24 192.168.1.1/24 192.168.2.1/24&quot;
# PG version
PG_VERSION='10'
# PG subversion
PG_SUB_VERSION='15'

# PG port
PG_PORT='5432'
# PG afo monitor port
PGM_PORT='5431'

# PG afo monitor hostname
PG_AFOM_HOSTNAME=&quot;pg-afom&quot;
# node list info
NODE_LIST=&quot;${PG_AFOM_HOSTNAME}:192.168.5.151 pg-node1:192.168.5.149 pg-node2:192.168.5.150 pg-node3:192.168.6.170&quot;
</code></pre>
<h1><a class="header" href="#4-è¿ç»´" id="4-è¿ç»´">4 è¿ç»´</a></h1>
<h2><a class="header" href="#41-pgafo" id="41-pgafo">4.1 pgafo</a></h2>
<pre><code class="language-shell">[root@pg-node1 PGHA]# ./pgafo -v

  ================================================
  #                 pgafo å·¥å…·                   #
  # ç‰ˆæœ¬ï¼š 1.0.0                                 #
  # ä½œè€…ï¼š Siu                                   #
  # æ”¯æŒï¼š postgres 10,11,12                     #
  # GCC: (GNU) 4.8.5 20150623 (Red Hat 4.8.5-28) #
  ================================================



Usage: ./pgafo -p
       ./pgafo -s
       ./pgafo -l
       ./pgafo -c local
       ./pgafo -p -c -i
       ./pgafo -d pg-node5

Options:
  -a      è®¾ç½®å½“å‰ç”¨æˆ· ssh å…å¯†
  -p      åˆå§‹åŒ–ä¸»æœº
  -c      æ¸…ç†æ—§ afo ç¯å¢ƒï¼ˆé‡è£…æ—¶éœ€è¦ï¼Œå¿…é¡»è¾“å…¥éªŒè¯ç äºŒæ¬¡ç¡®è®¤ï¼‰
  -i      å®‰è£… afo åŸºç¡€ç¯å¢ƒï¼ˆå¿…é¡»è¾“å…¥éªŒè¯ç äºŒæ¬¡ç¡®è®¤ï¼‰
  -r      å¯åŠ¨ afoã€afom
  -b      å¤‡ä»½ afo monitoræ•°æ®
  -n      æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯
  -s      æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯ï¼ˆèŠ‚ç‚¹æƒ…å†µã€è¿æ¥ä¸²ã€pg_autoctl é…ç½®æ–‡ä»¶ã€èŠ‚ç‚¹é…ç½®ï¼‰
  -d      åˆ é™¤èŠ‚ç‚¹ï¼ˆå¿…é¡»äºŒæ¬¡ç¡®è®¤ï¼‰
  -o      ä¸»åŠ¨æ•…éšœè½¬ç§»ï¼ˆå¿…é¡»äºŒæ¬¡ç¡®è®¤ï¼‰
  -g      è®¾ç½® postgresql.confï¼ˆéœ€è¦é‡å¯PGï¼‰
  -l      æŸ¥çœ‹æœåŠ¡æ—¥å¿—
  -m      ç»´æŠ¤èŠ‚ç‚¹
  -R      ç»´æŠ¤å®Œæˆï¼Œå¯ç”¨èŠ‚ç‚¹
  -h      å¸®åŠ©ä¿¡æ¯
  -v      pgafo å·¥å…·ç‰ˆæœ¬ä¿¡æ¯
</code></pre>
<h2><a class="header" href="#42-è¿ç»´æ“ä½œ" id="42-è¿ç»´æ“ä½œ">4.2 è¿ç»´æ“ä½œ</a></h2>
<h3><a class="header" href="#421-æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€" id="421-æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€">4.2.1 æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€</a></h3>
<blockquote>
<p>./pgafo -n 2  # æ¯éš”ä¸¤ç§’è¾“å‡ºå½“å‰èŠ‚ç‚¹çš„çŠ¶æ€</p>
</blockquote>
<p><img src="./assets/image-1-show-nodes.png" alt="image-20201209105213328" /></p>
<h3><a class="header" href="#422-æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—" id="422-æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—">4.2.2 æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—</a></h3>
<blockquote>
<p>./pgafo -l</p>
</blockquote>
<p><img src="./assets/image-2-show-logs.png" alt="image-20201209105432929" /></p>
<h3><a class="header" href="#423-èŠ‚ç‚¹ç»´æŠ¤" id="423-èŠ‚ç‚¹ç»´æŠ¤">4.2.3 èŠ‚ç‚¹ç»´æŠ¤</a></h3>
<blockquote>
<p>å°†èŠ‚ç‚¹ç½®ä¸ºç»´æŠ¤çŠ¶æ€ï¼Œé€‚ç”¨äºä¸»æœºå†…æ ¸å‡çº§ç­‰æƒ…å†µï¼›</p>
</blockquote>
<p><strong>Secondary èŠ‚ç‚¹ç»´æŠ¤</strong></p>
<blockquote>
<p>./pgafo -m</p>
</blockquote>
<p><img src="./assets/image-3-maintenance-secondary.png" alt="image-20201209105723122" /></p>
<p><strong>Primary èŠ‚ç‚¹ç»´æŠ¤</strong></p>
<blockquote>
<p>./pgafo -m</p>
</blockquote>
<p><img src="./assets/image-4-maintenance-primary.png" alt="image-20201209110001608" /></p>
<h3><a class="header" href="#424-èŠ‚ç‚¹ä¼¸ç¼©" id="424-èŠ‚ç‚¹ä¼¸ç¼©">4.2.4 èŠ‚ç‚¹ä¼¸ç¼©</a></h3>
<p><strong>åˆ é™¤èŠ‚ç‚¹</strong></p>
<blockquote>
<p>./pgafo -d [hostname]</p>
</blockquote>
<p><strong>å¢åŠ èŠ‚ç‚¹</strong></p>
<blockquote>
<p>å‚è€ƒå®‰è£…ï¼Œåªéœ€è¦åœ¨æ–°çš„èŠ‚ç‚¹å®‰è£…ä¸º postgres èŠ‚ç‚¹å³å¯æˆä¸ºæ–°çš„èŠ‚ç‚¹åŠ å…¥ã€‚</p>
</blockquote>
<h1><a class="header" href="#5-æµ‹è¯•" id="5-æµ‹è¯•">5 æµ‹è¯•</a></h1>
<table><thead><tr><th>åºå·</th><th>æµ‹è¯•é¡¹</th><th>é¢„æœŸ</th><th>ç›®çš„</th></tr></thead><tbody>
<tr><td>1</td><td>æ•…éšœè½¬ç§»æµ‹è¯•</td><td>1ï¼‰ã€ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹æ•…éšœï¼Œä¸å½±å“PGæœåŠ¡å’Œæ•°æ®å®Œæ•´<br/>2ï¼‰ã€ä»»æ„ä¸¤ä¸ªèŠ‚ç‚¹æ•…éšœï¼š <br/>                                   aã€æ‰€æœ‰ standby æ•…éšœï¼Œ å½“å¯ç”¨ standby èŠ‚ç‚¹æ•° &lt; number_sync_standbys æ—¶ PG æœåŠ¡å°†é™çº§ä¸ºåªè¯»ï¼›<br/>                                   bã€ä¸»èŠ‚ç‚¹å’Œå…¶ä¸­ä¸€ä¸ª standby èŠ‚ç‚¹æ•…éšœï¼Œä¸å½±å“PGæœåŠ¡ï¼Œæœ‰å¯èƒ½å½±å“æ•°æ®å®Œæ•´æ€§ï¼ˆå–ç»äºæ¥ç®¡ä¸»PGæœåŠ¡çš„èŠ‚ç‚¹æ˜¯å¦æ˜¯æœ€åæ‰§è¡Œå¤åˆ¶ä»²è£çš„èŠ‚ç‚¹æˆ–æ•…éšœæ—¶æœ‰æ— è¯»è¯·æ±‚ï¼‰<br/>3ï¼‰ã€Monitor æ•…éšœä¸å½±å“PGæœåŠ¡å’Œæ•°æ®å®Œæ•´æ€§ï¼Œåªä¼šå½±å“æ•…éšœè½¬ç§»ï¼›<br/>4ï¼‰ã€Monitor SPOF è§£å†³æ–¹æ¡ˆçš„å¯è¡Œæ€§ï¼›<br/>5ï¼‰ã€Monitor SPOF è§£å†³æ–¹æ¡ˆçš„å¯é æ€§ï¼›<br/>6ï¼‰ã€åŸºäºpg-auto-failover çš„PG HAæ–¹æ¡ˆçš„å¯é æ€§ï¼›</td><td>éªŒè¯ HAï¼Œfailoverå¯é æ€§</td></tr>
<tr><td>2</td><td>JDBC åº”ç”¨æµ‹è¯•</td><td>åº”ç”¨æ­£å¸¸ä½¿ç”¨</td><td>éªŒè¯ç°æœ‰åº”ç”¨ä½¿ç”¨ JDBC HAæ–¹å¼èƒ½æ­£å¸¸ä½¿ç”¨ï¼Œä¸šåŠ¡ä¸Šæ— ä¾µå…¥ã€‚</td></tr>
<tr><td>3</td><td>æ•°æ®åº“åŸºå‡†æµ‹è¯•</td><td>æ€§èƒ½å·®è·åœ¨ <strong>5% å·¦å³</strong>ï¼Œå°äº 10%</td><td>éªŒè¯æ–¹æ¡ˆï¼ŒJDBC HAæ–¹å¼è¿æ¥å¯¹æ€§èƒ½æ²¡æœ‰å½±å“ ã€‚</td></tr>
<tr><td>4</td><td>æ•°æ®åº“å‹æµ‹</td><td>/</td><td>æµ‹è¯•æ•°æ®ç¨³å®šæ€§ï¼Œå‘ç°æœªçŸ¥é—®é¢˜ã€‚</td></tr>
</tbody></table>
<h2><a class="header" href="#51--æ•…éšœè½¬ç§»æµ‹è¯•" id="51--æ•…éšœè½¬ç§»æµ‹è¯•">5.1  æ•…éšœè½¬ç§»æµ‹è¯•</a></h2>
<blockquote>
<p>ä¾æ® two-standby-sync æ¶æ„åšæ•´ä½“æ–¹æ¡ˆçš„åŠŸèƒ½å’Œå¯é æ€§éªŒè¯ã€‚</p>
</blockquote>
<h3><a class="header" href="#511-åœºæ™¯ä¸€-ä»»æ„ä¸€ä¸ª-pg-èŠ‚ç‚¹æ•…éšœ" id="511-åœºæ™¯ä¸€-ä»»æ„ä¸€ä¸ª-pg-èŠ‚ç‚¹æ•…éšœ">5.1.1 åœºæ™¯ä¸€ ï¼šä»»æ„ä¸€ä¸ª PG èŠ‚ç‚¹æ•…éšœ</a></h3>
<blockquote>
<p>â€‹		ç”±äºè¿™ç§åœºæ™¯ä¸‹ Secondary èŠ‚ç‚¹æ•…éšœå¹¶ä¸ä¼šè§¦å‘æ•…éšœè½¬ç§»ï¼ˆé‡æ–°é€‰æ‹©ä¸»èŠ‚ç‚¹ï¼‰ï¼Œæ•…åœ¨æµ‹è¯•ä¸­åˆ¶é€  Primary èŠ‚ç‚¹æ•…éšœã€‚</p>
</blockquote>
<table><thead><tr><th>Monitor</th><th>Primary</th><th>Scondary1</th><th>Scondary2</th><th>Available</th><th>Failover</th></tr></thead><tbody>
<tr><td>:heavy_check_mark:</td><td>:heavy_check_mark:</td><td>:heavy_check_mark:</td><td>:heavy_check_mark:</td><td><strong>æ˜¯</strong></td><td><strong>æ˜¯</strong></td></tr>
</tbody></table>
<p><strong>æ•…éšœè½¬ç§»æµ‹è¯•ï¼š</strong></p>
<ul>
<li>
<p>æ‰‹åŠ¨é€ æˆ Primary èŠ‚ç‚¹æœåŠ¡æ•…éšœï¼ˆæ–­ç”µï¼Œå…³æœºï¼‰ï¼›</p>
<p><img src="./assets/image-5-show-nodes-2.png" alt="" />
<img src="./assets/image-20201201170824122.png" alt="image-20201201170824122" /></p>
</li>
<li>
<p>è§‚å¯Ÿæ•…éšœè½¬ç§»ï¼šæ–°ä¸»èŠ‚ç‚¹äº§ç”Ÿï¼ŒåŸä¸»èŠ‚ç‚¹è¢«é™çº§</p>
<p><img src="./assets/image-7-show-nodes-3.png" alt="image-20201201171005957" /></p>
</li>
<li>
<p>é‡å¯åŸ Primary èŠ‚ç‚¹</p>
</li>
<li>
<p>è§‚å¯Ÿæ•…éšœè½¬ç§»ï¼šåŸ Primary èŠ‚ç‚¹é‡æ–°åŠ å…¥ï¼Œå¼€å§‹åŒæ­¥ LSN</p>
<p><img src="./assets/image-8-show-nodes-4.png" alt="image-20201201171116383" /></p>
</li>
<li>
<p>è§‚å¯Ÿæ•…éšœè½¬ç§»ï¼šæ–°çš„ Primary èŠ‚ç‚¹çŠ¶æ€ ä» join_primary å˜ä¸º primary</p>
<p><img src="./assets/image-9-show-nodes-5.png" alt="image-20201201170543638" /></p>
</li>
</ul>
<h3><a class="header" href="#512-åœºæ™¯äºŒ-ä»»æ„ä¸¤ä¸ª-pg-èŠ‚ç‚¹æ•…éšœ" id="512-åœºæ™¯äºŒ-ä»»æ„ä¸¤ä¸ª-pg-èŠ‚ç‚¹æ•…éšœ">5.1.2 åœºæ™¯äºŒ ï¼šä»»æ„ä¸¤ä¸ª PG èŠ‚ç‚¹æ•…éšœ</a></h3>
<blockquote>
<p>éªŒè¯ number_sync_standbys å’Œ synchronous_standby_names é…ç½®çš„å½±å“</p>
</blockquote>
<p><strong>æ•…éšœè½¬ç§»æµ‹è¯•1ï¼šä¸¤ä¸ª Secondary èŠ‚ç‚¹æ•…éšœ</strong></p>
<table><thead><tr><th>Monitor</th><th>Primary</th><th>Scondary1</th><th>Scondary2</th><th>Available</th><th>Failover</th></tr></thead><tbody>
<tr><td>:heavy_check_mark:</td><td>:heavy_check_mark:</td><td>:x:</td><td>:x:</td><td><strong>å¦</strong></td><td><strong>å¦</strong></td></tr>
</tbody></table>
<ul>
<li>
<p>æ‰‹åŠ¨é€ æˆä¸¤ä¸ª Secondary èŠ‚ç‚¹æ•…éšœï¼ˆæ–­ç”µ/å…³æœºï¼‰ï¼›</p>
<ul>
<li>
<p>å…³æœºå‰èŠ‚ç‚¹çŠ¶æ€</p>
<p><img src="./assets/image-23-show-nodes-12.png" alt="image-20201217141232815" /></p>
</li>
<li>
<p>pg-node2ã€pg-node3 å…³æœº ï¼ˆpg-node1 é™çº§åªè¯»ï¼Œå†™é˜»å¡ï¼‰</p>
<p><img src="./assets/image-24-show-nodes-13.png" alt="image-20201217144349908" /></p>
<p><img src="./assets/image-25-primary-node-write-block.png" alt="image-20201217142245830" /></p>
</li>
<li>
<p>è®¾ç½® number-sync-standbys=0 ,synchronous_standby_names=''ï¼ˆpg-node1 å¯è¯»å†™ï¼‰</p>
<pre><code class="language-shell"># è®¾ç½® number-sync-standbys = 0
/usr/pgsql-10/bin/pg_autoctl set formation number-sync-standbys 0 --pgdata /pgafo/monitor/pgafomonitor

# è®¾ç½® synchronous_standby_names = ''
/usr/pgsql-10/bin/pg_autoctl set node replication-quorum false --name pg-node2 --pgdata /pgafo/monitor/pgafomonitor
/usr/pgsql-10/bin/pg_autoctl set node replication-quorum false --name pg-node3 --pgdata /pgafo/monitor/pgafomonitor
</code></pre>
<p><img src="./assets/image-26-enable-write-on-all-standby-fail.png" alt="image-20201217144234770" /></p>
<p><img src="./assets/image-27-primary-node-writable.png" alt="image-20201217144520951" /></p>
</li>
</ul>
</li>
</ul>
<p><strong>æ•…éšœè½¬ç§»æµ‹è¯•2ï¼šPrimary èŠ‚ç‚¹æ•…éšœï¼Œä¸€ä¸ªSecondary æ•…éšœ</strong></p>
<table><thead><tr><th>Monitor</th><th>Primary</th><th>Scondary1</th><th>Scondary2</th><th>Available</th><th>Failover</th></tr></thead><tbody>
<tr><td>:heavy_check_mark:</td><td>:x:</td><td>:heavy_check_mark:</td><td>:x:</td><td><strong>æ˜¯</strong></td><td><strong>å¦</strong></td></tr>
</tbody></table>
<ul>
<li>
<p>æ‰‹åŠ¨é€ æˆ Primary å’Œä¸€ä¸ª Secondary èŠ‚ç‚¹æ•…éšœï¼ˆæ–­ç”µ/å…³æœºï¼‰ï¼›</p>
<ul>
<li>
<p>å…³æœºå‰èŠ‚ç‚¹çŠ¶æ€</p>
<p><img src="C:%5CUsers%5CWorkstation%5Cnotes%5C%E6%95%B0%E6%8D%AE%E5%BA%93%5CPG%5CPGHA%5Cassets%5Cimage-20201218093034525.png" alt="image-20201218093034525" /></p>
</li>
<li>
<p>å…³æœºåæ•…éšœè½¬ç§»ï¼ˆsynchronous_standby_names è‡ªåŠ¨é…ç½®ä¸ºç©ºï¼‰</p>
<p><img src="C:%5CUsers%5CWorkstation%5Cnotes%5C%E6%95%B0%E6%8D%AE%E5%BA%93%5CPG%5CPGHA%5Cassets%5Cimage-20201218093551078.png" alt="image-20201218093551078" /></p>
<p><img src="C:%5CUsers%5CWorkstation%5Cnotes%5C%E6%95%B0%E6%8D%AE%E5%BA%93%5CPG%5CPGHA%5Cassets%5Cimage-20201218093736339.png" alt="image-20201218093736339" /></p>
</li>
<li>
<p>æ•…éšœèŠ‚ç‚¹é‡æ–°åŠ å…¥ï¼ˆé‡å¯ pg-node2ã€pg-node3ï¼‰</p>
<p><img src="C:%5CUsers%5CWorkstation%5Cnotes%5C%E6%95%B0%E6%8D%AE%E5%BA%93%5CPG%5CPGHA%5Cassets%5Cimage-20201218100929700.png" alt="image-20201218100929700" /></p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>â€‹		Primary èŠ‚ç‚¹å’Œ Secondary èŠ‚ç‚¹åŒæ—¶æ•…éšœï¼Œå¦ä¸€ä¸ª Secondary èŠ‚ç‚¹å˜æˆå”¯ä¸€å‰¯æœ¬ï¼Œä¼šå‡çº§ä¸ºä¸»èŠ‚ç‚¹ï¼ˆwait_primaryï¼‰ï¼Œsynchronous_standby_names è‡ªåŠ¨é…ç½®ä¸ºç©ºï¼›å¾…æ•…éšœèŠ‚ç‚¹é‡æ–°åŠ å…¥æ—¶ï¼Œsynchronous_standby_names è‡ªåŠ¨é…ç½®ä¸ºç›¸åº”çš„é…ç½®ã€‚</p>
</blockquote>
<h3><a class="header" href="#513-åœºæ™¯ä¸‰monitor-èŠ‚ç‚¹æ•…éšœ" id="513-åœºæ™¯ä¸‰monitor-èŠ‚ç‚¹æ•…éšœ">5.1.3 åœºæ™¯ä¸‰ï¼šMonitor èŠ‚ç‚¹æ•…éšœ</a></h3>
<table><thead><tr><th>Monitor</th><th>Primary</th><th>Scondary1</th><th>Scondary2</th><th>Available</th><th>Failover</th></tr></thead><tbody>
<tr><td>:x:</td><td>:heavy_check_mark:</td><td>:heavy_check_mark:</td><td><em><strong>any</strong></em></td><td><strong>æ˜¯</strong></td><td><strong>å¦</strong></td></tr>
</tbody></table>
<p><strong>æ•…éšœè½¬ç§»æµ‹è¯•ï¼š</strong></p>
<ul>
<li>
<p>æ‰‹åŠ¨é€ æˆ ä¸€ä¸ª Monitor èŠ‚ç‚¹æ•…éšœï¼ˆæ–­ç”µ/å…³æœºï¼‰ï¼›</p>
</li>
<li>
<p>æ‰‹åŠ¨é€ æˆ ä¸€ä¸ª Secondary èŠ‚ç‚¹æ•…éšœï¼ˆæ–­ç”µ/å…³æœºï¼‰ï¼›</p>
</li>
<li>
<p>è§‚å¯ŸPGæœåŠ¡æ˜¯å¦å¯ç”¨ï¼›</p>
<p><img src="./assets/image-15-show-pg-status.png" alt="image-20201202154927886" /></p>
</li>
<li>
<p>é‡å¯ æ•…éšœèŠ‚ç‚¹ï¼Œæ¢å¤ï¼š</p>
<p><img src="./assets/image-16-show-nodes-11.png" alt="image-20201202160018382" /></p>
</li>
</ul>
<p><em><strong>æ³¨ï¼š</strong></em></p>
<blockquote>
<p><strong>å¯å¢åŠ  Monitor SPOF è§£å†³æ–¹æ¡ˆï¼Œé˜²æ­¢å•ç‚¹å½±å“</strong>ã€‚</p>
</blockquote>
<h3><a class="header" href="#514-monitor-æ•…éšœè½¬ç§»æµ‹è¯•" id="514-monitor-æ•…éšœè½¬ç§»æµ‹è¯•">5.1.4 Monitor æ•…éšœè½¬ç§»æµ‹è¯•</a></h3>
<table><thead><tr><th>Monitor1</th><th>Monitor2</th><th>Failover</th></tr></thead><tbody>
<tr><td>:x:</td><td>:heavy_check_mark:</td><td><strong>æ˜¯</strong></td></tr>
</tbody></table>
<p><strong>æ•…éšœè½¬ç§»æµ‹è¯•ï¼š</strong></p>
<ul>
<li>
<p>æ‰‹åŠ¨é€ æˆ ä¸€ä¸ª Monitor èŠ‚ç‚¹ï¼ˆMASTERï¼‰æ•…éšœï¼ˆæ–­ç”µ/å…³æœºï¼‰ï¼›</p>
<img src="./assets/image-17-show-monitor-1.png" style="zoom:70%" align=left />
</li>
</ul>
<img src="./assets/image-18-reboot.png" style="zoom:70%" align=left />
<ul>
<li>
<p>å¦ä¸€ä¸ªå¤‡ç”¨ Monitor èŠ‚ç‚¹æ¥ç®¡æœåŠ¡</p>
<img src="./assets/image-19-monitor-failover.png" style="zoom:170%" align=left />
</li>
</ul>
<img src="./assets/image-20-show-monitor-2.png" style="zoom:70%" align=left />
<h3><a class="header" href="#515-monitor-failover-å‹æµ‹" id="515-monitor-failover-å‹æµ‹">5.1.5 Monitor Failover å‹æµ‹</a></h3>
<blockquote>
<p>7 X 24å°æ—¶ ï¼Œæ¨¡æ‹ŸMonitor èŠ‚ç‚¹æ•…éšœï¼ˆä¸¤ä¸ªèŠ‚ç‚¹å…ˆåæ•…éšœï¼Œé—´éš”5åˆ†é’Ÿï¼Œæ¯å°æ—¶è§¦å‘ä¸€æ¬¡ï¼‰</p>
</blockquote>
<p><strong>ä¸¤ä¸ªèŠ‚ç‚¹æ¯ä¸ªå°æ—¶å®šæ—¶é‡å¯</strong></p>
<pre><code class="language-shell"># Node1
crontab -l
25 * * * * /sbin/reboot

# Node2
crontab -l
31 * * * * /sbin/reboot
</code></pre>
<p><em><strong>failover æ—¥å¿—ï¼š</strong></em></p>
<img src="./assets/image-21-monitor-failover-dblogs.png" style="zoom:120%" align=left />
<h3><a class="header" href="#516-primary-failover-å‹æµ‹" id="516-primary-failover-å‹æµ‹">5.1.6 Primary Failover å‹æµ‹</a></h3>
<blockquote>
<p>7 X 24å°æ—¶ ï¼Œæ¯ä¸ªå°æ—¶è®© Primary èŠ‚ç‚¹æ•…éšœä¸¤æ¬¡ï¼ˆé—´éš”10åˆ†é’Ÿï¼‰</p>
</blockquote>
<pre><code class="language-shell"># Node1
crontab -l
5 * * * * sh /opt/PGHA/failovertest.sh
55 * * * * sh /opt/PGHA/failovertest.sh

# Node2
crontab -l
5 * * * * sh /opt/PGHA/failovertest.sh
55 * * * * sh /opt/PGHA/failovertest.sh

# Node3
crontab -l
5 * * * * sh /opt/PGHA/failovertest.sh
55 * * * * sh /opt/PGHA/failovertest.sh
</code></pre>
<pre><code class="language-shell">#!/bin/bash
# failovertest.sh

is_secondary=$(sudo su postgres -c &quot;psql -p 5432 -c 'select * from pg_is_in_recovery();'&quot; | head -n 3|tail -n 1)
is_secondary=`echo $is_secondary`

# å¦‚æœæ˜¯ä¸»èŠ‚ç‚¹
if [[ ${is_secondary} == &quot;f&quot; ]]; then
  echo &quot;10ç§’åé‡å¯ç³»ç»Ÿ&quot;
  sleep 10
  /sbin/reboot
fi
</code></pre>
<p><em><strong>failover æ—¥å¿—</strong></em></p>
<p><img src="./assets/image-22-node-failover-dblogs.png" alt="image-20201216112912520" /></p>
<p><strong>å‹æµ‹ä¸­è¿›è¡Œæ•…éšœè½¬ç§»ï¼š</strong></p>
<p><img src="C:%5CUsers%5CWorkstation%5Cnotes%5C%E6%95%B0%E6%8D%AE%E5%BA%93%5CPG%5CPGHA%5Cassets%5Cimage-20201223103411327.png" alt="image-20201223103411327" /></p>
<h2><a class="header" href="#52-a-hrefhttpsjdbcpostgresqlorgdocumentationheadconnecthtmlconnection-parametersjdbc-æµ‹è¯•a" id="52-a-hrefhttpsjdbcpostgresqlorgdocumentationheadconnecthtmlconnection-parametersjdbc-æµ‹è¯•a">5.2 <a href="https://jdbc.postgresql.org/documentation/head/connect.html#connection-parameters">JDBC æµ‹è¯•</a></a></h2>
<blockquote>
<p>é©±åŠ¨ç‰ˆæœ¬ï¼š<a href="https://github.com/pgjdbc/pgjdbc">postgresql-42.2.11</a></p>
</blockquote>
<h3><a class="header" href="#521-ha-jdbcè¿æ¥" id="521-ha-jdbcè¿æ¥">5.2.1 HA JDBCè¿æ¥</a></h3>
<p><code>url: jdbc:postgresql://pg-node3:5432,pg-node2:5432,pg-node1:5432/dbname?targetServerType=master </code></p>
<blockquote>
<p><strong>æµ‹è¯•ç»“æœæ­£å¸¸</strong></p>
</blockquote>
<h3><a class="header" href="#522-è¯»å†™åˆ†ç¦»jdbcè¿æ¥" id="522-è¯»å†™åˆ†ç¦»jdbcè¿æ¥">5.2.2 è¯»å†™åˆ†ç¦»JDBCè¿æ¥</a></h3>
<blockquote>
<p>ï¼ˆå¾…éªŒè¯ï¼‰</p>
</blockquote>
<p><code>url: jdbc:postgresql://pg-node3:5432,pg-node2:5432,pg-node1:5432/dbname?targetServerType=perferSlave </code></p>
<h2><a class="header" href="#53-æ•°æ®åº“åŸºå‡†æµ‹è¯•" id="53-æ•°æ®åº“åŸºå‡†æµ‹è¯•">5.3 æ•°æ®åº“åŸºå‡†æµ‹è¯•</a></h2>
<blockquote>
<p>â€‹		åŸºå‡†æµ‹è¯•ä¸»è¦äº†ä» JDBC é©±åŠ¨å±‚åˆ°æ•°æ®åº“å±‚å®Œå…¨æ‰§è¡Œä¸€ä¸ªæŒ‡ä»¤æ‰€éœ€çš„æ—¶é’Ÿå‘¨æœŸï¼Œå³æµ‹è¯•ä¸­å®é™…æ‰§è¡Œçš„äº‹åŠ¡ã€‚</p>
</blockquote>
<h3><a class="header" href="#531-æµ‹è¯•ç¯å¢ƒ" id="531-æµ‹è¯•ç¯å¢ƒ">5.3.1 æµ‹è¯•ç¯å¢ƒ</a></h3>
<ul>
<li><a href="https://sourceforge.net/projects/benchmarksql/">æµ‹è¯•å·¥å…·ï¼šBenchMarkSQL 5.0</a> | <a href="https://support.huaweicloud.com/tstg-kunpengdbs/kunpengbenchmarksql_06_0002.html">ä½¿ç”¨æ–¹æ³•</a></li>
<li>PG ç‰ˆæœ¬ï¼š 10.15</li>
<li>PG æœåŠ¡å™¨ä¸»è¦å‚æ•°ï¼š 4C 8G</li>
<li>PG é©±åŠ¨ç‰ˆæœ¬ï¼špostgresql-42.2.11</li>
<li>å®¢æˆ·ç«¯å‚æ•°ï¼šç•¥</li>
</ul>
<blockquote>
<p>â€‹		BenchmarkSQL is an open source implementation of the popular TPC/C OLTP
database benchmark. Version 5.0 is a major overhaul of the benchmark driver.
This version supports Firebird, Oracle and PostgreSQL, adds foreign keys to
the schema (as required by the specifications) and captures detailed benchmark</p>
</blockquote>
<h3><a class="header" href="#532-æµ‹è¯•æ¨¡å‹tpc-c-æ ‡å‡†æµ‹è¯•" id="532-æµ‹è¯•æ¨¡å‹tpc-c-æ ‡å‡†æµ‹è¯•">5.3.2 æµ‹è¯•æ¨¡å‹ï¼šTPC-C æ ‡å‡†æµ‹è¯•</a></h3>
<p><strong>TPC-C æ ‡å‡†æµ‹è¯•æ¨¡æ‹Ÿäº† 5 ç§äº‹åŠ¡å¤„ç†ï¼Œé€šè¿‡è¿™äº›äº‹åŠ¡å¤„ç†æ¥æ¨¡æ‹ŸçœŸå®çš„ç”¨æˆ·æ“ä½œï¼Œäº‹åŠ¡åˆ†åˆ«ä¸º</strong>:</p>
<ul>
<li>æ–°è®¢å•ï¼ˆNew-Orderï¼‰</li>
<li>æ”¯ä»˜æ“ä½œ(Payment)</li>
<li>è®¢å•çŠ¶æ€æŸ¥è¯¢(Order-Status)</li>
<li>å‘è´§(Delivery)</li>
<li>åº“å­˜çŠ¶æ€æŸ¥è¯¢(Stock-Level)</li>
</ul>
<h3><a class="header" href="#533-benchmarksql-æŒ‡æ ‡è¯´æ˜" id="533-benchmarksql-æŒ‡æ ‡è¯´æ˜">5.3.3 BenchmarkSQL æŒ‡æ ‡è¯´æ˜</a></h3>
<ul>
<li>Latency è¡¨ç¤ºå®Œå…¨æ‰§è¡Œä¸€ä¸ªæŒ‡ä»¤æ‰€éœ€çš„æ—¶é’Ÿå‘¨æœŸï¼Œæ½œä¼æœŸè¶Šå°‘è¶Šå¥½ã€‚</li>
<li>tmpC è¡¨ç¤ºæ¯åˆ†é’Ÿæ‰§è¡Œçš„äº‹åŠ¡æ•°(NewOrders)</li>
<li>tmpTOTAL è¡¨ç¤ºæ¯åˆ†é’Ÿæ‰§è¡Œçš„æ€»äº‹åŠ¡æ•°</li>
<li>runMins BenchmarkSQL æµ‹è¯•æ¨¡å¼ï¼Œåˆ†ä¸º runTxnsPerTerminal å’Œ runMins ï¼š
<ul>
<li>runTxnsPerTerminal ï¼šæ¯ä¸ªç»ˆç«¯æ‰§è¡Œæ•°æ¨¡å¼</li>
<li>runMinsï¼šæ‰§è¡Œæ—¶é•¿æ¨¡å¼</li>
</ul>
</li>
</ul>
<h3><a class="header" href="#534-ha-jdbc-è¿æ¥åŸºå‡†æµ‹è¯•" id="534-ha-jdbc-è¿æ¥åŸºå‡†æµ‹è¯•">5.3.4 HA JDBC è¿æ¥åŸºå‡†æµ‹è¯•</a></h3>
<blockquote>
<p>é‡‡ç”¨ BenchmarkSQL runMins æ¨¡å¼è¿›è¡Œæµ‹è¯•ã€‚</p>
</blockquote>
<h4><a class="header" href="#5341-a-hrefpressure-testsingle_t16_10m1reporthtmlåŸºå‡†å‚ç…§æ•°æ®a" id="5341-a-hrefpressure-testsingle_t16_10m1reporthtmlåŸºå‡†å‚ç…§æ•°æ®a">5.3.4.1 <a href="./pressure-test/single_t16_10m#1/report.html">åŸºå‡†å‚ç…§æ•°æ®</a></a></h4>
<blockquote>
<p>â€‹		åŸºå‡†å‚ç…§æ•°æ®å–å•æœº JDBC è¿æ¥çš„çš„åŸºå‡†æµ‹è¯•ï¼Œå•æœºæ˜¯æŒ‡åªæœ‰ä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼Œæ²¡æœ‰ standby èŠ‚ç‚¹æ•°æ®å¤åˆ¶çš„å½±å“ã€‚æµ‹è¯•å¤šç»„ï¼Œä»¥ä¸‹æŒ‡æ ‡å±•ç¤ºä¸ºå…¸å‹å€¼ã€‚</p>
</blockquote>
<p><strong>Run Properties</strong></p>
<blockquote>
<p>10:45:09,874 [main] INFO   jTPCC : Term-00, +-------------------------------------------------------------+
10:45:09,875 [main] INFO   jTPCC : Term-00,      BenchmarkSQL v5.0
10:45:09,875 [main] INFO   jTPCC : Term-00, +-------------------------------------------------------------+
10:45:09,875 [main] INFO   jTPCC : Term-00,  (c) 2003, Raul Barbosa
10:45:09,875 [main] INFO   jTPCC : Term-00,  (c) 2004-2016, Denis Lussier
10:45:09,876 [main] INFO   jTPCC : Term-00,  (c) 2016, Jan Wieck
10:45:09,877 [main] INFO   jTPCC : Term-00, +-------------------------------------------------------------+
10:45:09,877 [main] INFO   jTPCC : Term-00,
10:45:09,878 [main] INFO   jTPCC : Term-00, db=postgres
10:45:09,878 [main] INFO   jTPCC : Term-00, driver=org.postgresql.Driver
10:45:09,879 [main] INFO   jTPCC : Term-00, conn=<strong>jdbc:postgresql://pg-node1:5432/pressure</strong>
10:45:09,879 [main] INFO   jTPCC : Term-00, user=postgres
10:45:09,879 [main] INFO   jTPCC : Term-00,
10:45:09,879 [main] INFO   jTPCC : Term-00, warehouses=10
10:45:09,879 [main] INFO   jTPCC : Term-00, terminals=16
10:45:09,880 [main] INFO   jTPCC : Term-00, runMins=10
10:45:09,880 [main] INFO   jTPCC : Term-00, limitTxnsPerMin=100000
10:45:09,880 [main] INFO   jTPCC : Term-00, terminalWarehouseFixed=true
10:45:09,880 [main] INFO   jTPCC : Term-00,
10:45:09,880 [main] INFO   jTPCC : Term-00, newOrderWeight=45
10:45:09,881 [main] INFO   jTPCC : Term-00, paymentWeight=43
10:45:09,881 [main] INFO   jTPCC : Term-00, orderStatusWeight=4
10:45:09,881 [main] INFO   jTPCC : Term-00, deliveryWeight=4
10:45:09,881 [main] INFO   jTPCC : Term-00, stockLevelWeight=4</p>
<p>10:55:31,085 [Thread-13] INFO   jTPCC : Term-00, Measured tpmC (NewOrders) = 5435.37
10:55:31,086 [Thread-13] INFO   jTPCC : Term-00, Measured tpmTOTAL = 12056.08
10:55:31,086 [Thread-13] INFO   jTPCC : Term-00, Session Start     = 2020-12-18 10:45:30
10:55:31,086 [Thread-13] INFO   jTPCC : Term-00, Session End       = 2020-12-18 10:55:31
10:55:31,086 [Thread-13] INFO   jTPCC : Term-00, Transaction Count = 120627</p>
</blockquote>
<p><strong>Result Summary</strong></p>
<table width="1100px" border="2">
    <tr>
      <th rowspan="2" width="16%"><b>Transaction<br/>Type</b></th>
      <th colspan="2" width="24%"><b>Latency</b></th>
      <th rowspan="2" width="12%"><b>Count</b></th>
      <th rowspan="2" width="12%"><b>Percent</b></th>
      <th rowspan="2" width="12%"><b>Rollback</b></th>
      <th rowspan="2" width="12%"><b>Errors</b></th>
      <th rowspan="2" width="12%"><b>Skipped<br/>Deliveries</b></th>
    </tr>
    <tr>
      <th width="12%"><b>90th&nbsp;%</b></th>
      <th width="12%"><b>Maximum</b></th>
    </tr>
    <tr>
      <td align="left">NEW_ORDER</td>
      <td align="right">0.139s</td>
      <td align="right">2.956s</td>
      <td align="right">54384</td>
      <td align="right">45.084%</td>
      <td align="right">1.081%</td>
      <td align="right">0</td>
      <td align="right">N/A</td>
    </tr>
    <tr>
      <td align="left">PAYMENT</td>
      <td align="right">0.050s</td>
      <td align="right">2.917s</td>
      <td align="right">51700</td>
      <td align="right">42.859%</td>
      <td align="right">N/A</td>
      <td align="right">0</td>
      <td align="right">N/A</td>
    </tr>
    <tr>
      <td align="left">ORDER_STATUS</td>
      <td align="right">0.017s</td>
      <td align="right">0.193s</td>
      <td align="right">4781</td>
      <td align="right">3.963%</td>
      <td align="right">N/A</td>
      <td align="right">0</td>
      <td align="right">N/A</td>
    </tr>
    <tr>
      <td align="left">STOCK_LEVEL</td>
      <td align="right">0.018s</td>
      <td align="right">0.617s</td>
      <td align="right">4863</td>
      <td align="right">4.031%</td>
      <td align="right">N/A</td>
      <td align="right">0</td>
      <td align="right">N/A</td>
    </tr>
    <tr>
      <td align="left">DELIVERY</td>
      <td align="right">0.000s</td>
      <td align="right">0.001s</td>
      <td align="right">4899</td>
      <td align="right">4.061%</td>
      <td align="right">N/A</td>
      <td align="right">0</td>
      <td align="right">N/A</td>
    </tr>
    <tr>
      <td align="left">DELIVERY_BG</td>
      <td align="right">0.441s</td>
      <td align="right">3.166s</td>
      <td align="right">4899</td>
      <td align="right">N/A</td>
      <td align="right">N/A</td>
      <td align="right">0</td>
      <td align="right">0</td>
    </tr>
    </table>
<p><strong>TPM and TL</strong></p>
<p><img src="./pressure-test/single_t16_10m#1/tpm_nopm.png" alt="" /></p>
<p><img src="./pressure-test/single_t16_10m#1/latency.png" alt="" /></p>
<h4><a class="header" href="#5342-a-hrefpressure-testha_t16_10m1reporthtmlha-jdbc-åŸºå‡†æµ‹è¯•æ•°æ®a" id="5342-a-hrefpressure-testha_t16_10m1reporthtmlha-jdbc-åŸºå‡†æµ‹è¯•æ•°æ®a">5.3.4.2 <a href="./pressure-test/ha_t16_10m#1/report.html">HA JDBC åŸºå‡†æµ‹è¯•æ•°æ®</a></a></h4>
<blockquote>
<p>æµ‹è¯•å¤šç»„ï¼Œä»¥ä¸‹æŒ‡æ ‡å±•ç¤ºä¸ºå…¸å‹å€¼ã€‚</p>
</blockquote>
<p><strong>Run Properties</strong></p>
<blockquote>
<p>12:17:50,020 [main] INFO   jTPCC : Term-00, +-------------------------------------------------------------+
12:17:50,020 [main] INFO   jTPCC : Term-00,      BenchmarkSQL v5.0
12:17:50,020 [main] INFO   jTPCC : Term-00, +-------------------------------------------------------------+
12:17:50,020 [main] INFO   jTPCC : Term-00,  (c) 2003, Raul Barbosa
12:17:50,020 [main] INFO   jTPCC : Term-00,  (c) 2004-2016, Denis Lussier
12:17:50,022 [main] INFO   jTPCC : Term-00,  (c) 2016, Jan Wieck
12:17:50,023 [main] INFO   jTPCC : Term-00, +-------------------------------------------------------------+
12:17:50,023 [main] INFO   jTPCC : Term-00,
12:17:50,023 [main] INFO   jTPCC : Term-00, db=postgres
12:17:50,023 [main] INFO   jTPCC : Term-00, driver=org.postgresql.Driver
12:17:50,023 [main] INFO   jTPCC : Term-00, conn=<strong>jdbc:postgresql://pg-node3:5432,pg-node2:5432,pg-node1:5432/pressure?targetServerType=master</strong>
12:17:50,023 [main] INFO   jTPCC : Term-00, user=postgres
12:17:50,023 [main] INFO   jTPCC : Term-00,
12:17:50,024 [main] INFO   jTPCC : Term-00, warehouses=10
12:17:50,024 [main] INFO   jTPCC : Term-00, terminals=16
12:17:50,025 [main] INFO   jTPCC : Term-00, runMins=10
12:17:50,025 [main] INFO   jTPCC : Term-00, limitTxnsPerMin=100000
12:17:50,025 [main] INFO   jTPCC : Term-00, terminalWarehouseFixed=true
12:17:50,025 [main] INFO   jTPCC : Term-00,
12:17:50,025 [main] INFO   jTPCC : Term-00, newOrderWeight=45
12:17:50,025 [main] INFO   jTPCC : Term-00, paymentWeight=43
12:17:50,025 [main] INFO   jTPCC : Term-00, orderStatusWeight=4
12:17:50,025 [main] INFO   jTPCC : Term-00, deliveryWeight=4
12:17:50,026 [main] INFO   jTPCC : Term-00, stockLevelWeight=4</p>
<p>12:28:21,752 [Thread-9] INFO   jTPCC : Term-00, Measured tpmC (NewOrders) = 4963.44
12:28:21,752 [Thread-9] INFO   jTPCC : Term-00, Measured tpmTOTAL = 10986.67
12:28:21,752 [Thread-9] INFO   jTPCC : Term-00, Session Start     = 2020-12-18 12:18:21
12:28:21,753 [Thread-9] INFO   jTPCC : Term-00, Session End       = 2020-12-18 12:28:21
12:28:21,753 [Thread-9] INFO   jTPCC : Term-00, Transaction Count = 109971</p>
</blockquote>
<p><strong>Result Summary</strong></p>
<table width="1100px" border="2">
    <tr>
      <th rowspan="2" width="16%"><b>Transaction<br/>Type</b></th>
      <th colspan="2" width="24%"><b>Latency</b></th>
      <th rowspan="2" width="12%"><b>Count</b></th>
      <th rowspan="2" width="12%"><b>Percent</b></th>
      <th rowspan="2" width="12%"><b>Rollback</b></th>
      <th rowspan="2" width="12%"><b>Errors</b></th>
      <th rowspan="2" width="12%"><b>Skipped<br/>Deliveries</b></th>
    </tr>
    <tr>
      <th width="12%"><b>90th&nbsp;%</b></th>
      <th width="12%"><b>Maximum</b></th>
    </tr>
    <tr>
      <td align="left">NEW_ORDER</td>
      <td align="right">0.170s</td>
      <td align="right">4.330s</td>
      <td align="right">49682</td>
      <td align="right">45.177%</td>
      <td align="right">1.012%</td>
      <td align="right">0</td>
      <td align="right">N/A</td>
    </tr>
    <tr>
      <td align="left">PAYMENT</td>
      <td align="right">0.062s</td>
      <td align="right">4.268s</td>
      <td align="right">47264</td>
      <td align="right">42.979%</td>
      <td align="right">N/A</td>
      <td align="right">0</td>
      <td align="right">N/A</td>
    </tr>
    <tr>
      <td align="left">ORDER_STATUS</td>
      <td align="right">0.016s</td>
      <td align="right">0.271s</td>
      <td align="right">4330</td>
      <td align="right">3.937%</td>
      <td align="right">N/A</td>
      <td align="right">0</td>
      <td align="right">N/A</td>
    </tr>
    <tr>
      <td align="left">STOCK_LEVEL</td>
      <td align="right">0.038s</td>
      <td align="right">0.447s</td>
      <td align="right">4386</td>
      <td align="right">3.988%</td>
      <td align="right">N/A</td>
      <td align="right">0</td>
      <td align="right">N/A</td>
    </tr>
    <tr>
      <td align="left">DELIVERY</td>
      <td align="right">0.000s</td>
      <td align="right">0.001s</td>
      <td align="right">4309</td>
      <td align="right">3.918%</td>
      <td align="right">N/A</td>
      <td align="right">0</td>
      <td align="right">N/A</td>
    </tr>
    <tr>
      <td align="left">DELIVERY_BG</td>
      <td align="right">0.455s</td>
      <td align="right">4.377s</td>
      <td align="right">4309</td>
      <td align="right">N/A</td>
      <td align="right">N/A</td>
      <td align="right">0</td>
      <td align="right">0</td>
    </tr>
    </table>
**TPM and TL**
<p><img src="./pressure-test/ha_t16_10m#1/tpm_nopm.png" alt="" /></p>
<p><img src="./pressure-test/ha_t16_10m#1/latency.png" alt="" /></p>
<h4><a class="header" href="#5343-åŸºå‡†æµ‹è¯•ç»“æœ" id="5343-åŸºå‡†æµ‹è¯•ç»“æœ">5.3.4.3 åŸºå‡†æµ‹è¯•ç»“æœ</a></h4>
<table width="1100px" border="2">
    <tr>
      <th rowspan="2" width="12%"><b>JDBC Type</b></th>
	  <th rowspan="2" width="8%"><b>Terminsls</b></th>
      <th colspan="3" width="30%" align="center"><b>tpmC</b></th>
	  <th colspan="3" width="30%" align="center"><b>tpmTOTAL</b></th>
	  <th colspan="2" width="20%" align="center"><b>Average</b></th>
    </tr>
    <tr>
      <th width="10%"><b>#1</b></th>
      <th width="10%"><b>#2</b></th>
      <th width="10%"><b>#3</b></th>
	  <th width="10%"><b>#1</b></th>
      <th width="10%"><b>#2</b></th>
      <th width="10%"><b>#3</b></th>
	  <th width="10%"><b>tpmC</b></th>
      <th width="10%"><b>tpmTOTAL</b></th>
    </tr>
    <tr>
      <td align="center">HA</td>
      <td align="center">16</td>
      <td align="right"><a href='./pressure-test/ha_t16_10m#1/report.html'>4963.44</a></td>
      <td align="right"><a href='./pressure-test/ha_t16_10m#2/report.html'>4898.79</a></td>
      <td align="right"><a href='./pressure-test/ha_t16_10m#3/report.html'>4657.05</a></td>
      <td align="right"><a href='./pressure-test/ha_t16_10m#1/report.html'>10986.67</a></td>
      <td align="right"><a href='./pressure-test/ha_t16_10m#2/report.html'>10883.45</a></td>
      <td align="right"><a href='./pressure-test/ha_t16_10m#3/report.html'>10324.87</a></td>
	  <td align="right">4839.76</td>
      <td align="right">10731.66</td>
    </tr>
    <tr>
      <td align="center">Single</td>
      <td align="center">16</td>
      <td align="right"><a href='./pressure-test/single_t16_10m#1/report.html'>5435.37</a></td>
      <td align="right"><a href='./pressure-test/single_t16_10m#2/report.html'>5114.47</a></td>
      <td align="right"><a href='./pressure-test/single_t16_10m#3/report.html'>5412.43</a></td>
      <td align="right"><a href='./pressure-test/single_t16_10m#1/report.html'>12056.08</a></td>
      <td align="right"><a href='./pressure-test/single_t16_10m#2/report.html'>11341.28</a></td>
      <td align="right"><a href='./pressure-test/single_t16_10m#3/report.html'>12007.29</a></td>
	  <td align="right">5320.76</td>
      <td align="right">11801.55</td>
    </tr>
    </table>
<h2><a class="header" href="#54-å‹æµ‹" id="54-å‹æµ‹">5.4 å‹æµ‹</a></h2>
<blockquote>
<p>å‹æµ‹ä¸»è¦æŒ‡æ ‡è§£è¯»å‚ç…§åŸºå‡†æµ‹è¯•ã€‚</p>
</blockquote>
<h4><a class="header" href="#a-hrefpressure-testha_t16_1h1reporthtmlterminal16-ä¸»è¦æŒ‡æ ‡a" id="a-hrefpressure-testha_t16_1h1reporthtmlterminal16-ä¸»è¦æŒ‡æ ‡a"><strong><a href="./pressure-test/ha_t16_1h#1/report.html">terminal=16 ä¸»è¦æŒ‡æ ‡</a></strong></a></h4>
<p><strong>Run Properties</strong></p>
<blockquote>
<p>db=postgres
driver=org.postgresql.Driver
conn=jdbc:postgresql://pg-node3:5432,pg-node2:5432,pg-node1:5432/pressure?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;targetServerType=master
user=postgres</p>
<p>warehouses=10
terminals=16
runMins=60
limitTxnsPerMin=100000</p>
<p>Running Average tpmTOTAL: 5960.14    Current tpmTOTAL: 2365524    Memory Usage: 117MB / 159MB</p>
<p>Measured tpmC (NewOrders) = 2677.05
Measured tpmTOTAL = 5960.14
Session Start     = 2020-11-30 15:17:35
Session End       = 2020-11-30 16:17:37
Transaction Count = 357847</p>
</blockquote>
<p><strong>Result Summary</strong></p>
<table width="1100px" border="2">
    <tr>
      <th rowspan="2" width="16%"><b>Transaction<br/>Type</b></th>
      <th colspan="2" width="24%"><b>Latency</b></th>
      <th rowspan="2" width="12%"><b>Count</b></th>
      <th rowspan="2" width="12%"><b>Percent</b></th>
      <th rowspan="2" width="12%"><b>Rollback</b></th>
      <th rowspan="2" width="12%"><b>Errors</b></th>
      <th rowspan="2" width="12%"><b>Skipped<br/>Deliveries</b></th>
    </tr>
    <tr>
      <th width="12%"><b>90th&nbsp;%</b></th>
      <th width="12%"><b>Maximum</b></th>
    </tr>
    <tr>
      <td align="left">NEW_ORDER</td>
      <td align="right">0.362s</td>
      <td align="right">16.688s</td>
      <td align="right">160731</td>
      <td align="right">44.916%</td>
      <td align="right">0.978%</td>
      <td align="right">0</td>
      <td align="right">N/A</td>
    </tr>
    <tr>
      <td align="left">PAYMENT</td>
      <td align="right">0.189s</td>
      <td align="right">14.234s</td>
      <td align="right">154400</td>
      <td align="right">43.147%</td>
      <td align="right">N/A</td>
      <td align="right">0</td>
      <td align="right">N/A</td>
    </tr>
    <tr>
      <td align="left">ORDER_STATUS</td>
      <td align="right">0.110s</td>
      <td align="right">2.864s</td>
      <td align="right">14371</td>
      <td align="right">4.016%</td>
      <td align="right">N/A</td>
      <td align="right">0</td>
      <td align="right">N/A</td>
    </tr>
    <tr>
      <td align="left">STOCK_LEVEL</td>
      <td align="right">0.072s</td>
      <td align="right">13.617s</td>
      <td align="right">14038</td>
      <td align="right">3.923%</td>
      <td align="right">N/A</td>
      <td align="right">0</td>
      <td align="right">N/A</td>
    </tr>
    <tr>
      <td align="left">DELIVERY</td>
      <td align="right">0.000s</td>
      <td align="right">0.001s</td>
      <td align="right">14307</td>
      <td align="right">3.998%</td>
      <td align="right">N/A</td>
      <td align="right">0</td>
      <td align="right">N/A</td>
    </tr>
    <tr>
      <td align="left">DELIVERY_BG</td>
      <td align="right">0.914s</td>
      <td align="right">14.876s</td>
      <td align="right">14307</td>
      <td align="right">N/A</td>
      <td align="right">N/A</td>
      <td align="right">0</td>
      <td align="right">0</td>
    </tr>
    </table>
<p><strong>TPM and TL</strong></p>
<p><img src="./pressure-test/ha_t16_1h#1/tpm_nopm.png" alt="" /></p>
<p><img src="./pressure-test/ha_t16_1h#1/latency.png" alt="" /></p>
<h4><a class="header" href="#a-hrefpressure-testha_t32_1h1reporthtmlterminal32-ä¸»è¦æŒ‡æ ‡a" id="a-hrefpressure-testha_t32_1h1reporthtmlterminal32-ä¸»è¦æŒ‡æ ‡a"><strong><a href="./pressure-test/ha_t32_1h#1/report.html">terminal=32 ä¸»è¦æŒ‡æ ‡</a></strong></a></h4>
<p><strong>Run Properties</strong></p>
<blockquote>
<p>db=postgres
driver=org.postgresql.Driver
conn=jdbc:postgresql://pg-node3:5432,pg-node2:5432,pg-node1:5432/pressure?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;targetServerType=master
user=postgres</p>
<p>warehouses=10
terminals=32
runMins=60
limitTxnsPerMin=100000</p>
<p>Running Average tpmTOTAL: 7846.76    Current tpmTOTAL: 3115428    Memory Usage: 44MB / 83MB</p>
<p>Measured tpmC (NewOrders) = 3519.94
Measured tpmTOTAL = 7846.88
Session Start     = 2020-11-30 11:40:57
Session End       = 2020-11-30 12:40:57
Transaction Count = 470833</p>
</blockquote>
<p><strong>Result Summary</strong></p>
<table width="1100px" border="2">
    <tr>
      <th rowspan="2" width="16%"><b>Transaction<br/>Type</b></th>
      <th colspan="2" width="24%"><b>Latency</b></th>
      <th rowspan="2" width="12%"><b>Count</b></th>
      <th rowspan="2" width="12%"><b>Percent</b></th>
      <th rowspan="2" width="12%"><b>Rollback</b></th>
      <th rowspan="2" width="12%"><b>Errors</b></th>
      <th rowspan="2" width="12%"><b>Skipped<br/>Deliveries</b></th>
    </tr>
    <tr>
      <th width="12%"><b>90th&nbsp;%</b></th>
      <th width="12%"><b>Maximum</b></th>
    </tr>
    <tr>
      <td align="left">NEW_ORDER</td>
      <td align="right">0.576s</td>
      <td align="right">13.890s</td>
      <td align="right">211206</td>
      <td align="right">44.858%</td>
      <td align="right">1.008%</td>
      <td align="right">0</td>
      <td align="right">N/A</td>
    </tr>
    <tr>
      <td align="left">PAYMENT</td>
      <td align="right">0.429s</td>
      <td align="right">14.443s</td>
      <td align="right">203260</td>
      <td align="right">43.170%</td>
      <td align="right">N/A</td>
      <td align="right">0</td>
      <td align="right">N/A</td>
    </tr>
    <tr>
      <td align="left">ORDER_STATUS</td>
      <td align="right">0.166s</td>
      <td align="right">2.983s</td>
      <td align="right">18754</td>
      <td align="right">3.983%</td>
      <td align="right">N/A</td>
      <td align="right">0</td>
      <td align="right">N/A</td>
    </tr>
    <tr>
      <td align="left">STOCK_LEVEL</td>
      <td align="right">0.065s</td>
      <td align="right">11.492s</td>
      <td align="right">18946</td>
      <td align="right">4.024%</td>
      <td align="right">N/A</td>
      <td align="right">0</td>
      <td align="right">N/A</td>
    </tr>
    <tr>
      <td align="left">DELIVERY</td>
      <td align="right">0.000s</td>
      <td align="right">0.005s</td>
      <td align="right">18667</td>
      <td align="right">3.965%</td>
      <td align="right">N/A</td>
      <td align="right">0</td>
      <td align="right">N/A</td>
    </tr>
    <tr>
      <td align="left">DELIVERY_BG</td>
      <td align="right">1.344s</td>
      <td align="right">16.202s</td>
      <td align="right">18667</td>
      <td align="right">N/A</td>
      <td align="right">N/A</td>
      <td align="right">0</td>
      <td align="right">0</td>
    </tr>
    </table>
<p><strong>TPM and TL</strong></p>
<p><img src="./pressure-test/ha_t32_1h#1/tpm_nopm.png" alt="" /></p>
<p><img src="./pressure-test/ha_t32_1h#1/latency.png" alt="" /></p>
<h2><a class="header" href="#55-æµ‹è¯•ç»“è®º" id="55-æµ‹è¯•ç»“è®º">5.5 æµ‹è¯•ç»“è®º</a></h2>
<blockquote>
<ul>
<li>æ•…éšœè½¬ç§»æµ‹è¯•
<ul>
<li><a href="#%E5%9C%BA%E6%99%AF%E4%B8%80">åœºæ™¯ä¸€</a>ï¼šéªŒè¯ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹æ•…éšœï¼Œéƒ½èƒ½ä¿è¯PGæœåŠ¡å¯ç”¨å’Œæ•°æ®å®‰å…¨ï¼Œ<strong>ç¬¦åˆé¢„æœŸ</strong>ï¼›</li>
<li><a href="#%E5%9C%BA%E6%99%AF%E4%BA%8C">åœºæ™¯äºŒ</a>ï¼šéªŒè¯äº†standby æ•…éšœï¼Œå½“å¯ç”¨ standby èŠ‚ç‚¹æ•° &lt; number_sync_standbys æ—¶ PG æœåŠ¡å°†<strong>é™çº§ä¸ºåªè¯»</strong>ï¼Œ<strong>ç¬¦åˆé¢„æœŸ</strong>ï¼›éªŒè¯äº†ä¸»èŠ‚ç‚¹å’Œä¸€ä¸ª standby èŠ‚ç‚¹æ•…éšœï¼Œä¸å½±å“å¯ç”¨æ€§ï¼Œ<strong>ç¬¦åˆé¢„æœŸ</strong>ï¼›</li>
<li><a href="#%E5%9C%BA%E6%99%AF%E4%B8%89">åœºæ™¯ä¸‰</a> éªŒè¯ Monitor èŠ‚ç‚¹æ•…éšœä¸å½±å“ PG æœåŠ¡ï¼Œ<strong>ç¬¦åˆé¢„æœŸ</strong>ï¼›</li>
<li><a href="">Monitor æ•…éšœè½¬ç§»æµ‹è¯•</a>éªŒè¯äº† Monitor SPOF è§£å†³æ–¹æ¡ˆçš„åŠŸèƒ½å¯è¡Œï¼Œ<strong>ç¬¦åˆé¢„æœŸ</strong>ï¼›</li>
</ul>
</li>
<li>åº”ç”¨ JDBC è¿æ¥æµ‹è¯•æ­£å¸¸ï¼Œ<strong>ç¬¦åˆé¢„æœŸ</strong>ï¼›</li>
<li>ä»åŸºå‡†æµ‹è¯•ç»“æœçš„ä¸¤ç»„æ•°æ®å¯¹æ¯”ä¸Šçœ‹ï¼ŒHA å’Œå•æœºè¿æ¥å•ä½æ—¶é—´å†…æ‰§è¡Œçš„äº‹åŠ¡æ•°å·®è·å¤§æ¦‚å·®è·åœ¨8%-10%ï¼ˆè¿™ä¸ªå·®è·ä¾æ®æµ‹è¯•æ¨¡å‹ä¸­ newOrder çš„æ•°æ®å¾—å‡ºï¼‰ï¼Œ<strong>ç•¥å¤§äºé¢„æœŸçš„5%</strong>ã€‚</li>
<li>å‹æµ‹ä¸­å‘ç°ï¼Œå¤§é‡çš„å†™æ“ä½œä¼šé€ æˆå¤åˆ¶èŠ‚ç‚¹pg_wal å¤§é‡å¢é•¿ï¼Œç£ç›˜å‹åŠ›å¢å¤§ï¼Œéœ€è¦å¢å¯¹ pg_wal å‚æ•°è¿›è¡Œè°ƒä¼˜ã€‚</li>
</ul>
</blockquote>
<h1><a class="header" href="#6--åº”ç”¨" id="6--åº”ç”¨">6  åº”ç”¨</a></h1>
<blockquote>
<p>ä»»ä½•é˜¶æ®µçš„é£é™©å’Œä¸é€‚ç”¨è¯„ä¼°éƒ½ä¼šå¯¹ä¸‹ä¸€é˜¶æ®µæœ‰å†³å®šæ€§çš„å½±å“ã€‚</p>
</blockquote>
<table><thead><tr><th>é˜¶æ®µ</th><th>è§„æ¨¡</th><th>ç›®æ ‡</th><th>ä¸‹ä¸ªé˜¶æ®µ</th><th>å¤‡æ³¨</th></tr></thead><tbody>
<tr><td>DEV_READY</td><td>2ä¸ªåº”ç”¨</td><td>failover å‹æµ‹ç¨³å®šè¿è¡Œ 1å‘¨</td><td>DEV</td><td><strong>å·²ç¨³å®šè¿è¡Œ7å¤©</strong></td></tr>
<tr><td>DEV</td><td>å…¨éƒ¨åº”ç”¨</td><td>ç¨³å®šè¿è¡Œ 3å‘¨</td><td>TEST</td><td>/</td></tr>
<tr><td>TEST</td><td>å…¨éƒ¨åº”ç”¨</td><td>ç¨³å®šè¿è¡Œ 3å‘¨</td><td>PROD_READY</td><td>/</td></tr>
<tr><td>PROD_READY</td><td>ç¬¦åˆä¸šåŠ¡è§„æ¨¡çš„å‹åŠ›æµ‹è¯•</td><td>ç¨³å®šè¿è¡Œ4å‘¨</td><td>PROD</td><td>/</td></tr>
<tr><td>PROD</td><td>å¾…å®š</td><td>/</td><td>/</td><td>/</td></tr>
</tbody></table>
<h1><a class="header" href="#7-æ€»ç»“" id="7-æ€»ç»“">7 æ€»ç»“</a></h1>
<blockquote>
<p>â€‹		PG HAæ–¹æ¡ˆè§£å†³äº†ç›®å‰ç”Ÿäº§ä¸Š PG å•ç‚¹æ•…éšœé—®é¢˜ï¼Œå®ç° Postgres æœåŠ¡å’Œæ•°æ®é›†çš„é«˜å¯ç”¨æ€§ï¼Œåœ¨åŸæœ‰ pg-auto-failover ä¹‹ä¸Šè¡¥å……äº† Monitor SPOF çš„è§£å†³æ–¹æ¡ˆã€‚æ•´ä½“æ–¹æ¡ˆåœ¨ DEV_READY é˜¶æ®µåšäº†å®Œæ•´æµ‹è¯•å’ŒéªŒè¯ï¼ŒåŒ…æ‹¬ï¼šæ•…éšœè½¬ç§»ï¼ˆå‹æµ‹ï¼‰ã€JDBC åº”ç”¨å±‚æ¥å…¥ã€æ•°æ®åº“åŸºå‡†ã€æ•°æ®åº“å‹æµ‹ï¼Œæµ‹è¯•ç»“æœåŸºæœ¬ç¬¦åˆé¢„æœŸï¼›æ•°æ®åŸºå‡†æµ‹è¯•æ€§èƒ½ä¸Šçš„å·®è·ä¸»å› æ˜¯åŒæ­¥çš„æµå¤åˆ¶ï¼Œæµå¤åˆ¶æ˜¯ä¸»æµ PG Active/Standby HA æ–¹æ¡ˆçš„åŸºç¡€ï¼Œè¿™éƒ¨åˆ†æ€§èƒ½ä¸Šçš„å·®è·åœ¨ç±»ä¼¼æ–¹æ¡ˆä¸Šä¹Ÿæ˜¯å­˜åœ¨çš„ï¼›åœ¨éªŒè¯å’Œæµ‹è¯•éƒ¨åˆ†ä¸‹ä¸ªé˜¶æ®µå¯ä»¥æ›´æ·±å…¥å…³æ³¨å¼‚æ­¥å¤åˆ¶çš„å½±å“ã€åŸºå‡†ä¸Šå‚ç…§å¯ä»¥è€ƒè™‘å¯¹æ¯”é pg-auto-failover ä¸­è‡ªåŠ¨é…ç½®çš„æµå¤åˆ¶ã€‚</p>
<p>â€‹		æ•´ä½“ä¸Šæ¨èæ–¹æ¡ˆè¿›å…¥ä¸‹ä¸€é˜¶æ®µçš„ä½¿ç”¨å’ŒéªŒè¯ã€‚</p>
<p>â€‹</p>
</blockquote>
<h1><a class="header" href="#é™„å½•" id="é™„å½•">é™„å½•</a></h1>
<h2><a class="header" href="#a-hrefhttpspg-auto-failoverreadthedocsioenlatestarchitecturehtmlpg-auto-failover-glossarypg_auto_failover-glossarya" id="a-hrefhttpspg-auto-failoverreadthedocsioenlatestarchitecturehtmlpg-auto-failover-glossarypg_auto_failover-glossarya"><a href="https://pg-auto-failover.readthedocs.io/en/latest/architecture.html#pg-auto-failover-glossary">pg_auto_failover Glossary</a></a></h2>
<table><thead><tr><th>æ¦‚å¿µ</th><th>æè¿°</th></tr></thead><tbody>
<tr><td>Formation</td><td><strong>ç¼–é˜Ÿ</strong>æ˜¯ä¸€èµ·ç®¡ç†çš„ PG æœåŠ¡çš„é€»è¾‘é›†åˆã€‚</td></tr>
<tr><td>Monitor</td><td><strong>Monitor</strong> æ˜¯ pg-auto-failover é‡Œçš„ä¸€ä¸ªæœåŠ¡ï¼Œç”¨äºè·Ÿè¸ªä¸€ä¸ªæˆ–å¤šä¸ªåŒ…å«<strong>èŠ‚ç‚¹ç»„</strong>çš„<strong>ç¼–é˜Ÿ</strong>ã€‚Monitor æœåŠ¡ä»¥ä¸€ä¸ª PG æ‰©å±•çš„æ–¹å¼å®ç°ï¼Œæ‰€ä»¥å½“åˆ›å»º Monitor æœåŠ¡æ—¶ï¼Œå°†ä¼šåˆå§‹åŒ–ä¸€ä¸ª PG å®ä¾‹ï¼Œå¹¶ä½¿ç”¨è¯¥æ‰©å±•è¿›è¡Œé…ç½®å’Œå¯åŠ¨ã€‚Monitor æœåŠ¡æ—¶åµŒå…¥åœ¨ PG å®ä¾‹é‡Œé¢çš„</td></tr>
<tr><td>Group</td><td><strong>èŠ‚ç‚¹ç»„</strong>ï¼Œ ä¸€ä¸ª<strong>èŠ‚ç‚¹ç»„</strong>ç”± PG ä¸»èŠ‚ç‚¹å’Œå…·æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªåŒæ­¥å¤åˆ¶çš„ standby èŠ‚ç‚¹ç»„æˆï¼Œä»¥ HA çš„æ–¹å¼æä¾›å•ä¸ª PG æœåŠ¡ã€‚</td></tr>
<tr><td>Keeper</td><td><strong>Keeper</strong> æ˜¯ pg-auto-failover çš„<strong>å®ˆæŠ¤ç¨‹åº</strong>ï¼Œå¿…é¡»åœ¨è¿è¡Œ PG èŠ‚ç‚¹çš„æœåŠ¡å™¨ä¸Šè¿è¡Œã€‚Keeper æ§åˆ¶æœ¬åœ°çš„ PG å®ä¾‹ï¼ˆé€šè¿‡ pg_ctl å‘½ä»¤å’Œ SQL æŸ¥è¯¢ï¼‰ï¼Œå¹¶ä¸ <strong>Monitor</strong> é€šä¿¡ï¼š<br/>      1ã€æ ¹æ®PG çš„ç»Ÿè®¡ä¿¡æ¯è§†å›¾ï¼Œå‘é€æœ¬åœ°èŠ‚ç‚¹çš„æ›´æ–°æ•°æ®ï¼Œä¾‹å¦‚æœåŠ¡å™¨ä¹‹é—´çš„ WAL å¢é‡<br/>     2ã€ä» Monitor æ¥å—çŠ¶æ€åˆ†é…</td></tr>
<tr><td>Node</td><td><strong>èŠ‚ç‚¹</strong>æ˜¯è¿è¡Œ PG å®ä¾‹å’Œ <strong>Keeper</strong> æœåŠ¡çš„æœåŠ¡å™¨ã€‚</td></tr>
<tr><td>State</td><td><strong>çŠ¶æ€</strong>æ˜¯æ¯ä¸ªå®ä¾‹å’Œæ¯ä¸ªç»„æƒ…å†µçš„è¡¨ç¤ºã€‚</td></tr>
</tbody></table>
<h2><a class="header" href="#a-hrefhttpspg-auto-failoverreadthedocsioenlatestfailover-state-machinehtmlstate-referencefailover-state-referencea" id="a-hrefhttpspg-auto-failoverreadthedocsioenlatestfailover-state-machinehtmlstate-referencefailover-state-referencea"><a href="https://pg-auto-failover.readthedocs.io/en/latest/failover-state-machine.html#state-reference">Failover State reference</a></a></h2>
<img src="./assets/arch-Failover-State-Machine.svg" style="zoom:175%" />
<table><thead><tr><th>çŠ¶æ€</th><th>æè¿°</th><th>åœºæ™¯</th></tr></thead><tbody>
<tr><td><a href="https://pg-auto-failover.readthedocs.io/en/latest/failover-state-machine.html#init">init</a></td><td>èŠ‚ç‚¹<strong>ç¬¬ä¸€æ¬¡</strong>å‘ Monitor <strong>æ³¨å†Œ</strong>æ—¶ï¼Œè¢«åˆ†é…çš„çŠ¶æ€ï¼›è¿™æ—¶é™¤äº†çŸ¥é“èŠ‚ç‚¹<strong>å­˜åœ¨</strong>ï¼Œå¹¶ä¸çŸ¥é“èŠ‚ç‚¹çš„ä»»ä½•ä¿¡æ¯ã€‚</td><td>/</td></tr>
<tr><td><a href="https://pg-auto-failover.readthedocs.io/en/latest/failover-state-machine.html#single">single</a></td><td><strong>åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹</strong>æ—¶ï¼Œæˆ–å…¶ä»–èŠ‚ç‚¹è¢«åˆ é™¤æ—¶ï¼›æ­¤æ—¶ç›¸å½“äºå½“ä¸ª PG å®ä¾‹ï¼Œæ²¡æœ‰ HA å’Œ failoverçš„èƒ½åŠ›ã€‚</td><td>/</td></tr>
<tr><td><a href="https://pg-auto-failover.readthedocs.io/en/latest/failover-state-machine.html#wait-primary">wait_primary</a></td><td>è®¡åˆ’æˆä¸ºä¸»èŠ‚ç‚¹ï¼ˆprimaryï¼‰ï¼Œä½†è¿˜æœªæˆä¸ºæ—¶ï¼›æ­¤æ—¶è¿™ä¸ªèŠ‚ç‚¹å·²çŸ¥ standby èŠ‚ç‚¹çš„ä¿¡æ¯ï¼ˆåç§°ã€IPï¼‰ï¼Œå¹¶å…è®¸ hot standby ï¼ˆå¤åˆ¶è¿æ¥ï¼‰ã€‚</td><td>1ã€æ–°çš„å¥åº·èŠ‚ç‚¹æ³¨å†Œæ—¶ <br/>2ã€ç°æœ‰ Secondary èŠ‚ç‚¹ä¸å¥åº·æ—¶ï¼ˆè¿™ç§æƒ…å†µä¸‹ï¼Œä» priamry åˆ° wait_primary è¿™æ®µæ—¶é—´å†…ï¼ŒåŒæ­¥å¤åˆ¶å’ŒæŸ¥è¯¢éƒ½ä¼šè¢«é™åˆ¶ï¼‰</td></tr>
<tr><td><a href="https://pg-auto-failover.readthedocs.io/en/latest/failover-state-machine.html#join-primary">join_primary</a></td><td>å½“ standby èŠ‚ç‚¹åŠ å…¥æ—¶ï¼Œåº”ç”¨äºä¸»èŠ‚ç‚¹ï¼›æ­¤æ—¶ä¸»èŠ‚ç‚¹å°†ä¿®æ”¹HBA è®¾ç½®ï¼Œä¹‹åæ–°çš„èŠ‚ç‚¹æ‰èƒ½ä½¿ç”¨ pg_basebackup å‘½ä»¤ã€‚</td><td>/</td></tr>
<tr><td><a href="https://pg-auto-failover.readthedocs.io/en/latest/failover-state-machine.html#primary">primary</a></td><td>å½“ä¸»èŠ‚ç‚¹å­˜åœ¨ä¸€ä¸ªå¥åº·çš„ standby èŠ‚ç‚¹ï¼Œå¹¶ä¸” WAL å¤åˆ¶è½åä¸º0ã€‚</td><td>/</td></tr>
<tr><td><a href="https://pg-auto-failover.readthedocs.io/en/latest/failover-state-machine.html#wait-standby">wait_standby</a></td><td>Monitor åˆ¤å®šä¸º standby èŠ‚ç‚¹ï¼Œæ­¤æ—¶ç­‰å¾…ä¸»èŠ‚ç‚¹æˆæƒå…è®¸ hot standbyï¼ˆå¤åˆ¶è¿æ¥ï¼‰ã€‚</td><td>/</td></tr>
<tr><td><a href="https://pg-auto-failover.readthedocs.io/en/latest/failover-state-machine.html#catchingup">catching_up</a></td><td>ä¸»èŠ‚ç‚¹å…è®¸ hot standbyï¼ˆå¤åˆ¶è¿æ¥ï¼‰æ—¶ï¼Œstandby èŠ‚ç‚¹è¢«åˆ†é…çš„çŠ¶æ€ã€‚</td><td>/</td></tr>
<tr><td><a href="https://pg-auto-failover.readthedocs.io/en/latest/failover-state-machine.html#secondary">secondary</a></td><td>æ˜¯ä¸»èŠ‚ç‚¹çš„ hot standby ï¼ŒWAL æ˜¯æœ€æ–°çš„ã€‚</td><td>/</td></tr>
<tr><td><a href="https://pg-auto-failover.readthedocs.io/en/latest/failover-state-machine.html#maintenance">maintenance</a></td><td>èŠ‚ç‚¹è¿›å…¥ç»´æŠ¤çŠ¶æ€ã€‚</td><td>/</td></tr>
<tr><td><a href="https://pg-auto-failover.readthedocs.io/en/latest/failover-state-machine.html#prepare-maintenance">prepare_maintenance</a></td><td>ä¸»èŠ‚ç‚¹è¿›å…¥ç»´æŠ¤çŠ¶æ€å‰çš„ä¸­é—´çŠ¶æ€ï¼Œç¡®ä¿ standby èŠ‚ç‚¹å®Œæˆæ‰€æœ‰å†™ç¡®è®¤ã€‚</td><td>/</td></tr>
<tr><td><a href="https://pg-auto-failover.readthedocs.io/en/latest/failover-state-machine.html#wait-maintenance">wait-maintenance</a></td><td>standby èŠ‚ç‚¹è¿›å…¥ç»´æŠ¤çŠ¶æ€å‰çš„ä¸­é—´çŠ¶æ€ï¼›ä¸ºäº†ç¡®ä¿å†™ä¸ä¼šè¢«é˜»å¡ï¼ŒèŠ‚ç‚¹ä¼šè¢«åˆ‡æ¢åˆ°å¼‚æ­¥å¤åˆ¶ã€‚</td><td>/</td></tr>
<tr><td><a href="https://pg-auto-failover.readthedocs.io/en/latest/failover-state-machine.html#draining">draining</a></td><td>primary å’Œ demoted ä¹‹é—´çš„ä¸­é—´çŠ¶æ€ï¼Œç­‰å¾…å¤åˆ¶ç¼“å†²åŒºå®Œæˆåˆ·æ–°ï¼›æ­¤æ—¶èŠ‚ç‚¹å°†ä¸ä¼šæ¥å—æ–°çš„å†™è¯·æ±‚ã€‚</td><td>ä¸»èŠ‚ç‚¹æ•…éšœæ—¶ï¼Œè¢«é™çº§</td></tr>
<tr><td><a href="https://pg-auto-failover.readthedocs.io/en/latest/failover-state-machine.html#demoted">demoted</a></td><td>ä¸»èŠ‚ç‚¹å¤„äºé™çº§çŠ¶æ€ï¼ŒPG å®ä¾‹å°†ä¼šè¢«åœæ­¢ã€‚</td><td></td></tr>
<tr><td><a href="https://pg-auto-failover.readthedocs.io/en/latest/failover-state-machine.html#demote-timeout">demote-timeout</a></td><td>ä¸»èŠ‚ç‚¹è¢« Monitor åˆ†é… demoted çŠ¶æ€ï¼Œä½†ä¸»èŠ‚ç‚¹ä¸Šçš„ keeper æœåŠ¡æœªåœ¨è¶…æ—¶çª—å£å†…è¿›è¡Œç¡®è®¤æ”¶åˆ°ï¼Œæ­¤æ—¶Monitor ä¼šåˆ†é… demote-timeout ç»™ä¸»èŠ‚ç‚¹ã€‚</td><td>ä¸»èŠ‚ç‚¹çªç„¶æ–­ç”µæˆ–å…³æœºäº†ï¼Œè¢«é™çº§ï¼Œkeeper æœåŠ¡æœªæŠ¥å‘ŠçŠ¶æ€ã€‚</td></tr>
<tr><td><a href="https://pg-auto-failover.readthedocs.io/en/latest/failover-state-machine.html#stop-replication">stop-replication</a></td><td>stop-replication çŠ¶æ€ç¡®ä¿åœ¨æ•…éšœè½¬ç§»æ—¶ï¼Œä¸»æ•°æ®åº“å…ˆè¿›å…¥ demotedï¼ˆé™çº§ï¼‰çŠ¶æ€ï¼Œ standby æ‰å˜ä¸ºå•ä¸ªæ•°æ®åº“ï¼ˆå¯å†™ï¼‰ã€‚</td><td></td></tr>
<tr><td><a href="https://pg-auto-failover.readthedocs.io/en/latest/failover-state-machine.html#prepare-promotion">prepare-promotion</a></td><td>prepare_promotion çŠ¶æ€ç”¨äºå‡†å¤‡å°† standby æœåŠ¡å™¨å‡çº§ã€‚</td><td></td></tr>
<tr><td><a href="https://pg-auto-failover.readthedocs.io/en/latest/failover-state-machine.html#report-lsn">report-lsn</a></td><td>å½“æ•…éšœè½¬ç§»æ—¶ï¼Œå­˜åœ¨å¤šä¸ª standby èŠ‚ç‚¹æ—¶ï¼Œå°†report_lsn çŠ¶æ€åˆ†é…ç»™ standby èŠ‚ç‚¹ï¼›Monitor å°†ä¼šé€‰æ‹©åç§»æœ€å¤§ LSN ä½œä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œæ‰€ä»¥æ‰€æœ‰ standby ä¼šå…ˆæŠ¥å‘Šæœ€æ–°çš„ LSNã€‚</td><td></td></tr>
<tr><td><a href="https://pg-auto-failover.readthedocs.io/en/latest/failover-state-machine.html#fast-forward">fast-forward</a></td><td>æ•…éšœè½¬ç§»æ—¶ï¼Œå½“ä¸€ä¸ª standby èŠ‚ç‚¹è¢«é€‰ä¸ºä¸»èŠ‚ç‚¹æ˜¯å› ä¸º candidate-priority é…ç½®ï¼ˆæ¯”å…¶å®ƒèŠ‚ç‚¹çš„å¤§ï¼‰ï¼Œè€Œä¸æ˜¯å› ä¸ºå®ƒçš„ LSN åç§»æœ€å¤§ï¼Œæ­¤æ—¶èŠ‚ç‚¹ä¼šè¢«åˆ†é… fast_forward çŠ¶æ€ï¼Œç”±æ­¤èŠ‚ç‚¹ä¼šåˆ©ç”¨ PG çº§è”å¤åˆ¶åŠŸèƒ½ï¼Œä»æœ€å¤§ LSN  standby èŠ‚ç‚¹è·å–ä¸¢å¤±çš„ WALã€‚</td><td></td></tr>
</tbody></table>
<h2><a class="header" href="#a-hrefhttpspg-auto-failoverreadthedocsioenlatestfailover-state-machinehtmlfailover-logicfailover-logica" id="a-hrefhttpspg-auto-failoverreadthedocsioenlatestfailover-state-machinehtmlfailover-logicfailover-logica"><a href="https://pg-auto-failover.readthedocs.io/en/latest/failover-state-machine.html#failover-logic">Failover logic</a></a></h2>
<h3><a class="header" href="#node-state-machine" id="node-state-machine">Node state machine</a></h3>
<p><img src="./assets/arch-auto-HA-node-states.svg" alt="" /></p>
<h3><a class="header" href="#group-state-machine" id="group-state-machine">Group state machine</a></h3>
<p><img src="./assets/arch-auto-HA-group-states.svg" alt="" /></p>
<h1><a class="header" href="#fqa" id="fqa">FQA</a></h1>
<p><a href="https://zhuanlan.zhihu.com/p/166218704">pg_wal æ–‡ä»¶è†¨èƒ€</a></p>
<p><a href="http://www.postgres.cn/docs/10/wal-configuration.html">wal configuration</a></p>
<p><a href="http://www.postgres.cn/news/viewone/1/273">å¦‚ä½•éåˆ¶PostgreSQL WALçš„ç–¯ç‹‚å¢é•¿</a></p>
<p>è™šæ‹Ÿæœºä¸‹ä½¿ç”¨ huge_page é‡å¯åï¼Œhuge_pageå¤±æ•ˆï¼ŒPGä¼šé‡å¯å¤±è´¥</p>
<p><a href="https://www.modb.pro/db/14150">PostgreSQLæ•°æ®åº“Linuxå†…æ ¸å‚æ•°è°ƒä¼˜</a></p>
<p><a href="http://www.pgsql.tech/project_300_10000084">PostgreSQLä¼˜åŒ–ä¹‹Linux å†…æ ¸å‚æ•°è°ƒä¼˜</a></p>
<p><a href="http://citusdb.cn/?p=1076">pg-auto-failover ä»‹ç»</a></p>
<p><a href="https://github.com/citusdata/pg_auto_failover">pg-auto-failover source code</a></p>
<p><a href="https://pg-auto-failover.readthedocs.io/en/latest/install.html">install pg-auto-failover</a></p>
<p><a href="https://pg-auto-failover.readthedocs.io/en/latest/tutorial.html">pg-auto-failover docs</a></p>
<p><a href="https://pg-auto-failover.readthedocs.io/en/latest/architecture.html#pg-auto-failover-glossary">pg-auto-failover glossary</a></p>
<p><a href="https://pg-auto-failover.readthedocs.io/en/latest/failover-state-machine.html">pg-auto-failover: failover state machine</a></p>
<p><a href="https://pg-auto-failover.readthedocs.io/en/latest/architecture.html#synchronous-vs-asynchronous-replication">pg-auto-failover : number_sync_standby</a></p>
<p><a href="https://pg-auto-failover.readthedocs.io/en/latest/architecture.html#client-side-ha">pg-auto-failover : Client Side HA</a></p>
<p><a href="https://pg-auto-failover.readthedocs.io/en/latest/ref/configuration.html">pg-auto-failover configuration</a></p>
<p><a href="https://pg-auto-failover.readthedocs.io/en/latest/architecture-multi-standby.html?#number-sync-standbys">Set Number Sync Standbys</a></p>
<p><a href="https://jdbc.postgresql.org/documentation/head/connect.html#connection-parameters">postgres jdbc connection parameters</a></p>
<p><a href="https://pg-auto-failover.readthedocs.io/en/latest/faq.html#the-monitor-is-a-spof-in-pg-auto-failover-design-how-should-we-handle-that">the monitor is a spof in pg-auto-failover design how should we handle that</a></p>
<p><a href="https://help.aliyun.com/document_detail/173284.html">è‡ªåŠ¨æ•…éšœè½¬ç§»å’Œè¯»å†™åˆ†ç¦»</a></p>
<p><a href="https://developer.aliyun.com/article/73930">è¯»å†™åˆ†ç¦»</a></p>
<p><a href="https://sourceforge.net/projects/benchmarksql/">æµ‹è¯•å·¥å…·ï¼šBenchMarkSQL</a> | <a href="https://support.huaweicloud.com/tstg-kunpengdbs/kunpengbenchmarksql_06_0002.html">ä½¿ç”¨æ–¹æ³•</a></p>
<p><a href="https://pgpool.net/mediawiki/index.php/Main_Page">Pgpool-II</a></p>
<p><a href="https://patroni.readthedocs.io/en/latest/">Patroni</a></p>
<p><a href="https://repmgr.org/">Repmgr</a></p>
<p><a href="https://www.postgresql.org/docs/10/warm-standby-failover.html">PostgreSQL Failoverã€Warm Standby</a> </p>
<p><a href="https://jdbc.postgresql.org/documentation/head/connect.html#connection-parameters">PostgreSQl Connection parameters</a></p>
<p><a href="https://www.postgresql.org/docs/10/kernel-resources.html">Postgres Kernel Resources</a></p>
<p><a href="https://baike.baidu.com/item/%E5%8D%95%E7%82%B9%E6%95%85%E9%9A%9C/3570893">SPOF</a>: å•ç‚¹æ•…éšœ (single point of failure)</p>
<p><a href="https://www.cnblogs.com/kevingrace/p/6248941.html">Keepalived åŸç†å’Œ VRRP åè®®</a></p>
<p><a href="https://my.oschina.net/u/4262664/blog/3326804">Keepalived VIP åˆ‡æ¢é…ç½®</a></p>
<p><a href="https://keepalived-doc.readthedocs.io/zh_CN/latest/%E6%9C%AF%E8%AF%AD.html">keepalived-doc</a></p>
<p><a href="https://cloud.tencent.com/developer/article/1496311">Linux é€»è¾‘å·åˆ›å»ºã€æŒ‚è½½</a></p>
<p><a href="https://blog.csdn.net/meanshe/article/details/52065873">yum rpm ç¼“å­˜è·¯å¾„</a> | <a href="https://www.jianshu.com/p/a295d7b1e3b3">yum ç¼“å­˜é…ç½®</a></p>
<p><a href="https://blog.csdn.net/msdnchina/article/details/81167888">BenchmarkSQL  æ¨èé…ç½®</a></p>

                        <div id="giscus-container"></div>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../../tech/backend/Java-Backend-Framework-Selection-Guide.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../../tech/project/kubesphere/åŸºäºLinuxå®‰è£…kubesphere3å¤šèŠ‚ç‚¹é›†ç¾¤(prod).html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../../tech/backend/Java-Backend-Framework-Selection-Guide.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../../../tech/project/kubesphere/åŸºäºLinuxå®‰è£…kubesphere3å¤šèŠ‚ç‚¹é›†ç¾¤(prod).html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../book.js" type="text/javascript" charset="utf-8"></script>
        <script type="text/javascript" charset="utf-8">
        var pagePath = "tech/project/PGHA/pg-ha-solution.md"
        </script>


        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src="../../../assets/custom.js"></script>
        
        <script type="text/javascript" src="../../../assets/showBigPicture.js"></script>
        

        

    </body>
</html>